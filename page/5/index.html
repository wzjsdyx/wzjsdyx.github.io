<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/animal_toy_cute_doll_teddy_72.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/animal_toy_cute_doll_teddy_72.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wzjsdyx.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="show me bug">
<meta property="og:type" content="website">
<meta property="og:title" content="芯青年">
<meta property="og:url" content="https://wzjsdyx.github.io/page/5/index.html">
<meta property="og:site_name" content="芯青年">
<meta property="og:description" content="show me bug">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Youngster">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://wzjsdyx.github.io/page/5/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>芯青年</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">芯青年</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/17/C%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/17/C%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">C条件编译</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-17 10:20:36" itemprop="dateCreated datePublished" datetime="2024-06-17T10:20:36+08:00">2024-06-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-26 10:53:03" itemprop="dateModified" datetime="2024-06-26T10:53:03+08:00">2024-06-26</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8FC%E7%A8%8B%E5%BA%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式C程序</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8FC%E7%A8%8B%E5%BA%8F/C-C-%E8%AF%AD%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">C/C++语法</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/17/C%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/17/C%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>C语言条件编译宏定义</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifdef</span> xxx</span></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> xxx</span></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>



<p>参考文档：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/Jason_from_China/article/details/137441684">C语言–条件编译（常见的编译指令）</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/" class="post-title-link" itemprop="url">3 AMBA/AHB/APB（2）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-15 23:54:36" itemprop="dateCreated datePublished" datetime="2024-06-15T23:54:36+08:00">2024-06-15</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-07-12 10:15:52" itemprop="dateModified" datetime="2024-07-12T10:15:52+08:00">2024-07-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%BA%E4%BA%8ECortex-M%E7%9A%84SoC%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">基于Cortex-M的SoC设计</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>AHB中，可以将传输分成</p>
<p>transfer：单次传输或者burst传输</p>
<p>beat：单次传输或者burst的一次传输</p>
</blockquote>
<h1 id="More-details-on-the-AHB-protocol"><a href="#More-details-on-the-AHB-protocol" class="headerlink" title="More details on the AHB protocol"></a>More details on the AHB protocol</h1><h2 id="Address-phase-signals"><a href="#Address-phase-signals" class="headerlink" title="Address phase signals"></a>Address phase signals</h2><h3 id="essential-transfer-control-signals"><a href="#essential-transfer-control-signals" class="headerlink" title="essential transfer control signals"></a>essential transfer control signals</h3><p>地址阶段有几个非常重要的控制信号，HTRANS，HADDR，HWRITE，HSIZE。</p>
<hr>
<h4 id="HTRANS"><a href="#HTRANS" class="headerlink" title="HTRANS"></a>HTRANS</h4><p>HTRANS用于表明传输类型。大部分的AHB系统其实并不需要一直进行数据传输，Master此时可以发出idle transfer。HTRANS就是用来表明什么时候是active transfer，什么时候是idle state；</p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240616165415891.png" class="">

<p>当正真需要传输数据的时候，Master会生成NSEQ或者SEQ的transfer类型；</p>
<blockquote>
<p>NSEQ的传输类型用于正常的数据传输（非burst传输），或者burst传输的第一笔transfer</p>
<p>SEQ就用于burst传输的剩余transfer，表明当前transfer是上一笔transaction的延续；</p>
</blockquote>
<p>IDLE和BUSY都是non-active传输，即不会传输实际的数据。BUSY类型的transfer类型仅在如下场景使用：</p>
<blockquote>
<p>master发起一次burst transaction，但是在burst发送的过程中，master没有准备好处理下一笔data transfer，那么此时就会发出busy的transfer，以保持burst传输的连续性，并在master ready的时候继续burst传输。</p>
</blockquote>
<p>IDLE类型的transfer前面已经说过了，就是Master不需要transaction的时候</p>
<hr>
<h4 id="HADDR"><a href="#HADDR" class="headerlink" title="HADDR"></a>HADDR</h4><p>HADDR用32bits表示，用于指定传输的地址；</p>
<h4 id="HWRITE"><a href="#HWRITE" class="headerlink" title="HWRITE"></a>HWRITE</h4><p>HWRITE用于表明当前是write transfer还是read transfer</p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240616172147763.png" class="">

<h4 id="HSIZE"><a href="#HSIZE" class="headerlink" title="HSIZE"></a>HSIZE</h4><p>HSIZE信号是3bits位宽，用于表明一次transfer的data size。大多数的AHB系统仅仅用到了低2bits。</p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240616172322146.png" class="">



<p><font color=blue>当一个bus的master发起传输的时候，bus master要去确保数据是transfer对其的，即word传输，地址就要是4Byte对齐；half-word传输，地址就要是2Byte对齐</font></p>
<p><font color=blue>AHB interface不支持unaligned transfer；如果master需要进行unaligned 访问，那么就需要拆分成多个align transfer；</font></p>
<blockquote>
<p>说明：</p>
<p>Cortex-M处理器的AHB接口能够发出byte&#x2F;half-word&#x2F;word size的读写访问</p>
</blockquote>
<hr>
<h3 id="optional-sideband-signals"><a href="#optional-sideband-signals" class="headerlink" title="optional sideband signals"></a>optional sideband signals</h3><p>除了上面几个关键的AHB信号，还有一些可选的sideband信号，他们可以提供一些有用的信息，例如特权级信息，以及支持的burst类型信息；</p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240616174912975.png" class="">

<hr>
<h4 id="HPROT"><a href="#HPROT" class="headerlink" title="HPROT"></a>HPROT</h4><p>AMBA 2 AHB以及AHB-Lite协议中，HPROT信号的每个bit有不同的作用：</p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240616175218009.png" class="">

<p>当访问normal memories（sram等）时候，HPROT[3:2]可以用来表示cache types</p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240616175631251.png" class="">



<p>AMBA 5 AHB协议中，HPROT信号的每个bit有不同的作用：</p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240616175828205.png" class="">

<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240616175901131.png" class="">

<blockquote>
<p>思考：</p>
<p>cache types??</p>
<p><font color=red>没懂啥意思？？这个属性是不是MPU发出的？？</font></p>
<p>说明：</p>
<p>1、Cortex-M0处理器没有user access level  ，HPROT[1] is always 1  ；</p>
<p>2、Cortex-M0&#x2F;M0+&#x2F;M3&#x2F;M4&#x2F;M23&#x2F;M33 处理器不支持内部cache, 因此cacheable的一些控制信号一般不会用到</p>
</blockquote>
<h4 id="HBURST"><a href="#HBURST" class="headerlink" title="HBURST"></a>HBURST</h4><p><font color=blue>HBURST信号表明burst传输的类型。当mem device针对顺序访问做了优化时，burst传输就能够优化系统性能。</font></p>
<blockquote>
<p>思考：</p>
<p>&#x3D;&#x3D;》burst传输时怎样优化传输带宽的？</p>
<p>Burst传输可以提高系统性能主要有两个关键原因：减少开销和最大化内存带宽利用。</p>
<p><strong>减少开销：</strong> 在处理器或主设备发起内存访问时，通常会涉及到设置和完成每个单独事务的开销。这包括地址传输、命令传输以及连续访问之间的延迟。在burst传输中，可以在初始设置后以较少的开销发起多个数据访问。一旦burst序列开始，后续的数据传输在burst长度内需要的开销较少，因为地址和其他控制信号通常是预先建立或由硬件递增管理。</p>
<p><strong>最大化内存带宽利用：</strong> 内存设备（如DRAM）通常具有优化连续数据访问的内部机制（如DRAM中的页面打开策略）。Burst传输利用这些机制，连续地访问burst长度内的内存位置。这减少了每个访问之间的时间间隙，有效地最大化了内存带宽的利用率。因此，与非burst（单周期）传输相比，数据传输的整体吞吐量增加。</p>
<p><strong>例子说明：</strong> 假设一个处理器需要读取存储在内存中的大块顺序数据。如果没有burst传输，处理器将为每个内存位置单独发起读取命令，这将导致大量的地址设置、命令传输以及每个访问之间的延迟开销。</p>
<p>然而，使用burst传输时，处理器可以发起一个单一命令，指示burst传输模式并指定起始地址。内存控制器随后连续从连续的内存位置中检索数据字，通常不需要为burst长度内的每个访问重新发起地址。这减少了发起每个访问的时间开销，从而提高了数据检索的效率和速度。</p>
<p>总之，burst传输通过减少开销和最大化内存带宽利用来优化系统性能，特别适用于需要顺序数据访问或大数据传输的场景。</p>
<p>&#x3D;&#x3D;》 AHB协议中 Burst的意义何在，为何要有这种feature?</p>
<p>(1) ”只发首地址，后续地址不用发“用于降低功耗之类 肯定是不对的。因为AHB协议明确规定收地址发出后，接下来的地址一个也不能少。</p>
<p>(2) 对于从机来说，不同之处在于，从机可以提前知道”主机的访问计划“，进而提早做准备，对于特定的从机来说，能够显著提高效率。</p>
<p>   举个例子: 对于单周期访问，零时延的SRAM&#x2F;寄存器来说，burst没有起到作用。但是对于一些慢速的从机，例如DDR，就可以提前知道主机的访问，然后以pipeline的方式访问某个打开的row，提高效率，如此。</p>
</blockquote>
<p>AHB 支持如下几种burst  transfer：</p>
<ul>
<li><p>Single. (Not burst transfer. Each transfer is separated from each other.)  </p>
</li>
<li><p>Incrementing burst transfer. (The address is incremented by the size of the transfer.)  </p>
</li>
<li><p>Wrapping burst transfer. For each transfer, the address increments as in an incrementing burst<br>except when the address reaches the block size boundary of the burst. In this case, the address<br>wraps round to the beginning of the block size boundary. The block size of the burst can be<br>determined from the number of beats times the size of each transfer.</p>
</li>
</ul>
<p><font color=blue>Burst transfer是由多个beats组成，每个beat的地址都和相邻beat有关</font>。burst transfer中，每个beat的控制信号都是相同的。Both incrementing and wrapping bursts are supported for 4-beats, 8-beats, and 16-beats transfers. Incremental bursts can also be of unspecified length.  </p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240616184400696.png" class="">

<p><font color=blue>wrap burst在cache controller设计中有用</font>。例如，处理器想要访问0x1008，cache controller的cache line是4 words，那就需要取0x1000, 0x1004, 0x1008 and 0x100C到cache memory中，这种情况下，可以从0x1000地址使用4拍递增burst传输，也可以从0x1008使用wrap burst传输。</p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240616211837581.png" class="">

<blockquote>
<p> 第一种和第二种情况，虽然传输的数据相同，但是wrap会先传输处理器所需要的数据，减少处理器的等待时间。</p>
<p>第三种情况，increment burst就不会获取0x1000和0x1004的数据，cache line的数据就不完整；</p>
</blockquote>
<p><font color=blue>burst transfer可以用不同的data size进行传输，但是其传输的过程中，有一个限制，那就是不能够超过1KB地址边界。</font></p>
<blockquote>
<p>协议上这么规定是有两个好处:</p>
<p>1、内部计数器和高级地址生成：为了优化burst传输的性能，AHB主设备和从设备可能需要内部计数器来监控burst操作，并可能提前产生地址。通过将burst传输限制到1KB Size，10bits的计数器就足够访问所有的burst transfer；</p>
<p>2、防止burst transfer跨越多个AHB Slave：如果burst transfer跨device 边界访问，那么跨边界的第二个device可能有一个开头是SEQ的burst transfer，违反了AHB协议；</p>
<p>（ARM对AHB burst这样设计的目的是在于，<font color=blue>SLAVE的地址访问空间基本都是以1KB为单位的</font>，设定burst不超过1KB是为了让一个单独的BURST不能访问多个slave，从而违反AHB协议；）</p>
<p>3、若需要跨1KB边界时，需要重新initial一个新的传输。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">例如：访问如下地址</span><br><span class="line">0x3F00 x3F40 x3F80 x3FC0 x4000 x4040 x4080</span><br><span class="line">1KB地址边界传输就需要按照如下规则访问：</span><br><span class="line">NSEQ SEQ SEQ SEQ NSEQ SEQ SEQ</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="HMASTERLOCK"><a href="#HMASTERLOCK" class="headerlink" title="HMASTERLOCK"></a>HMASTERLOCK</h4><p><font color=blue>对于atomic access sequence ，通常使用HMASTLOCK 表示总线的所有权是否被锁定，通常用于信号量操作</font></p>
<p>HMASTLOCK被设置为1的时候，总线部件（例如arbiter）不能够切换总线的所有权。针对信号量的操作，即有一个地址空间（lock flag）被用来表明某一个资源是否被进程或者处理器锁定，当处理器需要锁定某一个source的时候，需要执行locked transfer sequence（reads the lock flag and then<br>updates it  ）。使用HMASTLOCK，read-modify-write transfers are locked (atomic)  ，其他bus master在此期间就无法修改lock flag，防止竞争的情况发生。</p>
<blockquote>
<p>说明：</p>
<p>除了Cortex-M3以及Cortex-M4处理器，大多数的Cortex-M处理器不需要使用HMASTERLOCK信号</p>
</blockquote>
<h4 id="HMASTER"><a href="#HMASTER" class="headerlink" title="HMASTER"></a>HMASTER</h4><p>在多bus master的AHB系统中，Arbiter或者Master Multiplexer 可能会输出一个HMASTER信号，用于表明是哪一个AHB Master。</p>
<p>在某些场景中，AHB Slave可能需要对不同的AHB Master访问有不同的行为。例如MPU就可能对Cortex-M，debugger，DMA以及其他Master做出不同的行为。</p>
<blockquote>
<p>在Cortex-M处理器中，通常会使用HMASTER信号来表明当前的transfer是Cortex-M发出还是Debugger发出</p>
</blockquote>
<blockquote>
<p>传输类型</p>
<p>burst类型</p>
<p>beat传输数据大小</p>
</blockquote>
<h2 id="Data-phase-signals"><a href="#Data-phase-signals" class="headerlink" title="Data phase signals"></a>Data phase signals</h2><img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240620225155600.png" class="">





<h3 id="HRDATA-and-HWDATA"><a href="#HRDATA-and-HWDATA" class="headerlink" title="HRDATA and HWDATA"></a>HRDATA and HWDATA</h3><p><font color=blue>传输的数据在总线上的位置取决于transfer size</font></p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240620194927328.png" class="">

<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240620194939436.png" class="">

<p>For word transfers, the whole 32-bit is used  .</p>
<p><font color=blue>不管是哪种AHB协议，仅支持对齐传输&#x3D;&#x3D;》地址是传输size的整数倍</font></p>
<p>例如，word传输，地址是4的倍数；</p>
<p>half-word传输，地址是2的倍数；</p>
<p>byte传输，地址是1的倍数，也就是永远对齐；</p>
<h3 id="HRESP"><a href="#HRESP" class="headerlink" title="HRESP"></a>HRESP</h3><p><font color=blue>AMBA2 AHB协议中，response包括，OKAY，ERROR,RETRY,SPLIT四种类型，因此HRESP有2bit；</font></p>
<p><font color=blue>但是在AMBA 3 AHB LITE以及AMBA5 AHB中，仅仅只有OKAY和ERROR两种信号，因此HRESP只需要1bit</font></p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240620200157299.png" class="">

<p><font color=blue>只有OK response在一拍内完成，其他类型的response需要两拍完成；</font></p>
<blockquote>
<p>NOTE:</p>
<p>例如返回ERROR</p>
<ul>
<li>第一拍 HREADY low + ERROR：</li>
</ul>
<p>这一拍是给master留出反应时间，让其可以停止再发送下一次tranfer的有效地址，防止已经发生错误了，但是仍然还进行访问的操作；</p>
<ul>
<li>第二排 HREADY high+ERROR：</li>
</ul>
<p>实际的ERROR response</p>
</blockquote>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240620201916174.png" class="">

<blockquote>
<p>NOTE:</p>
<p>1、如上图所示，response也是可以插入wait status（HREADYOUT high，response OK）；</p>
<p>2、error response的第一拍（HREADYOUT low，response ERROR），master能够选择继续发送下一笔还是取消发送下一笔，然后发送IDLE状态；</p>
<p>不同的Cortex-M系列的处理器，其行为不一样；</p>
</blockquote>
<p><font color=blue>HTRANS是IDLE或者BUSY，又或者HSEL是not active，AHB Slave必须要返回OKAY；</font></p>
<p><font color=blue>RETRY和SPLIT信号和ERROR response的时序相同，他们的使用场景是，如果AHB Slave在短时间内无法完成传输的时候，他们会让AHB Master暂时放弃当前的传输；在多AHB Master的系统中，通过这种做法，就能让其他AHB Master有机会占用总线，防止带宽被浪费</font></p>
<p><font color=blue>AHB Master对RETRY和SPLIT信号的处理方式是不同的</font></p>
<ul>
<li>RETRY：AHB Master接收到第一个RETRY response cycle的时候，会通过发送一个IDLE来取消当前传输，然后再去retry未完成的传输；</li>
<li>SPLIT：AHB Master接收到第一个SPLITresponse cycle的时候，会通过发送一个IDLE来取消当前传输，同时会放弃总线所有权，等AHB Slave ready的时候再通过HSPLIT sideband信号恢复总线所有权；</li>
</ul>
<blockquote>
<p>由于复杂的机制，SPLIT以及HSPLIT基本很少使用；</p>
<p>从2001年的multi-layer AHB开始，SPLIT以及HSPLIT就被淘汰了，因为他能够有效的阻止单次传输降低系统性能的问题，能够提供更高的系统带宽；</p>
<p>有些Cortex-M processors 例如M3,M4有两bit的 HRESP信号，是因为其release时间比AMBA3 AHB-Lite release时间早；</p>
</blockquote>
<h3 id="HEXOKAY"><a href="#HEXOKAY" class="headerlink" title="HEXOKAY"></a>HEXOKAY</h3><p> <font color=blue>HEXOKAY信号用于支持互斥访问，在AMBA5 AHB中被引入，是由global exlcusive access monitor生成</font></p>
<p><font color=blue>互斥访问操作序列包括对同一个数据的<code>exclusive load</code>以及<code>exclusive store</code>，monitor将会检测在一个master的互斥访问序列中，其操作的数据是否会被其他Master进行修改，如果发现两个master访问冲突，将会通过HEXOKAY信号返回错误状态</font></p>
<p>在exclusive store发生，并且没有access conflit的时候，HEXOKAY和HREADY在同一个Cycle assert；其他的case，HEXOKAY维持low；</p>
<p>HEXOKAY不能和HRESP在同一个cycle assert；</p>
<h2 id="Legacy-arbiter-handshake-signals"><a href="#Legacy-arbiter-handshake-signals" class="headerlink" title="Legacy arbiter handshake signals"></a>Legacy arbiter handshake signals</h2><p>如果使用的是AMBA2 AHB协议，就需要考虑arbiter的handshake信号（但是一般来说，multi-layer AHB的性能更好，而且兼容AMBA2 AHB）；</p>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240620232339504.png" class="">

<blockquote>
<p>需要请求信号HBUSREQ，HGRANT授权信号；授权信号HLOCK表示进行一次locked transfer （可选）</p>
<p>仲裁阶段在地址阶段前，如果地址阶段有多个周期，仲裁结果也会随之不断更新</p>
</blockquote>
<img src="/2024/06/15/3-AMBA-AHB-APB%EF%BC%882%EF%BC%89/image-20240620234744237.png" class="">



<p>参考博客：</p>
<ol>
<li><p><a target="_blank" rel="noopener" href="https://blog.eetop.cn/blog-910906-5755032.html">AHB burst功能理解</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/550883187">AHB协议-HREADY信号和1KB边界</a></p>
</li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/12/secure-debug/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/12/secure-debug/" class="post-title-link" itemprop="url">secure debug</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-12 10:35:31 / 修改时间：10:36:11" itemprop="dateCreated datePublished" datetime="2024-06-12T10:35:31+08:00">2024-06-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%A6%E8%A7%84MCU/" itemprop="url" rel="index"><span itemprop="name">车规MCU</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/12/secure-debug/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/12/secure-debug/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/12/SOTA-secure-boot%E6%96%B9%E6%A1%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/12/SOTA-secure-boot%E6%96%B9%E6%A1%88/" class="post-title-link" itemprop="url">SOTA + secure boot方案</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-12 09:53:14 / 修改时间：10:36:39" itemprop="dateCreated datePublished" datetime="2024-06-12T09:53:14+08:00">2024-06-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%A6%E8%A7%84MCU/" itemprop="url" rel="index"><span itemprop="name">车规MCU</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/12/SOTA-secure-boot%E6%96%B9%E6%A1%88/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/12/SOTA-secure-boot%E6%96%B9%E6%A1%88/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>主要有如下几个部分：</p>
<ul>
<li><p>bank0 《&#x3D;&#x3D;》bank0校验参数页</p>
</li>
<li><p>bank1 《&#x3D;&#x3D;》bank1校验参数页</p>
</li>
<li><p>SOTA swap配置页</p>
</li>
</ul>
<p>其中：</p>
<ul>
<li>bank0，bank1会做硬件swap；</li>
<li>bank0校验参数页，bank1校验参数页没做硬件swap，由romcode根据SOTA swap配置去读取相应的校验参数页</li>
</ul>
<img src="/2024/06/12/SOTA-secure-boot%E6%96%B9%E6%A1%88/image-20240612102802897.png" class="">


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/12/secure-boot/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/12/secure-boot/" class="post-title-link" itemprop="url">secure boot</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-12 09:52:42" itemprop="dateCreated datePublished" datetime="2024-06-12T09:52:42+08:00">2024-06-12</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-17 15:17:58" itemprop="dateModified" datetime="2024-06-17T15:17:58+08:00">2024-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%A6%E8%A7%84MCU/" itemprop="url" rel="index"><span itemprop="name">车规MCU</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/12/secure-boot/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/12/secure-boot/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>车规芯片中，有secure boot的选项，即对Flash中的user code进行校验，防止非法修改</p>
</blockquote>
<p>大致的工作流程如下:</p>
<p>1、host romcode执行，此时的romcode会读取（dflash info&#x2F;OTP区域）<code>secure boot配置</code>（hsm enable，secure boot enable等）；</p>
<p>2、如果secure boot enable，则读取（pflash info区域）<code>secure boot的校验参数</code>（verify size，boot address， HSM public key addr，HSM code signature addr等）与HSM交互，然后对Flash的特定区域进行校验；</p>
<hr>
<h1 id="同事1"><a href="#同事1" class="headerlink" title="同事1"></a>同事1</h1><h2 id="hsm的程序分成两个部分"><a href="#hsm的程序分成两个部分" class="headerlink" title="hsm的程序分成两个部分"></a>hsm的程序分成两个部分</h2><ul>
<li><p>第一部分是hsm romcode程序（存放在hsm rom中）</p>
</li>
<li><p>第二部分是hsm firmware程序（存放在dflash bank1中）</p>
</li>
</ul>
<p>工作机制大致是：hsm reset释放之后，先执行hsm romcode的程序，用来校验firmware中的code</p>
<h2 id="build-secure-boot所需要的文件"><a href="#build-secure-boot所需要的文件" class="headerlink" title="build secure boot所需要的文件"></a>build secure boot所需要的文件</h2><ul>
<li><p>host romcode &amp; hsm romcode</p>
</li>
<li><p>dflash info: OTP(存放秘钥)</p>
</li>
<li><p>dflash main: FW&#x2F;firmware&#x2F;hsm image&#x2F;</p>
</li>
</ul>
<p>不同的算法，就会生成不同的fw和otp</p>
<h2 id="想要测试的点"><a href="#想要测试的点" class="headerlink" title="想要测试的点"></a>想要测试的点</h2><ul>
<li>能否正确等到HSM的状态&#x2F;ready信号</li>
<li>能否下命令调动HSM</li>
<li>host能否boot起来</li>
</ul>
<hr>
<h1 id="同事2"><a href="#同事2" class="headerlink" title="同事2"></a>同事2</h1><h2 id="pflash-info区域的参数"><a href="#pflash-info区域的参数" class="headerlink" title="pflash info区域的参数"></a>pflash info区域的参数</h2><ul>
<li><p>verify size[31:0]：hsm需要验证的代码大小</p>
</li>
<li><p>boot addr[31:0]：hsm需要验证的代码的起始地址</p>
</li>
<li><p>HSM public key address：如果使用非对称HSM算法，就需要提供公钥所在的地址</p>
</li>
<li><p>HSM code signature address：签名地址，将pflash usercode计算出来的MAC值（非对称，直接利用软件&#x2F;工具计算出来的结果） 存放在某一个地址处，例如pflash info或者pflash main等等</p>
</li>
</ul>
<blockquote>
<p>签名值：</p>
<ul>
<li><p>非对称HSM算法计算出来的签名值–&gt;签名</p>
</li>
<li><p>​     对称HSM算饭计算出来的签名值–&gt;MAC值</p>
</li>
</ul>
</blockquote>
<ul>
<li><p>Header size：如果不需要osr处理之后的head参与计算，此size配置为0</p>
</li>
<li><p>Header address：</p>
</li>
</ul>
<blockquote>
<p>关于head的理解，一般编译之后，会生成pflash main区域的user code；OSR会对这个user code进行处理，</p>
<p>然后会在签名值和code之间添加很多其他信息，例如Code public key，code size等等–》OSR 命名为head</p>
<p>计算最终的code_Signature签名值的时候，有可能将head的一部分和usercode一起参与计算</p>
</blockquote>
<img src="/2024/06/12/secure-boot/image-20240613193648354.png" class="">



<ul>
<li>Version address</li>
</ul>
<blockquote>
<p>head中会有一个版本号，如果head中的版本号小于pflash info中提供的版本号，<font color=red>就不会去更新版本号??</font></p>
</blockquote>
<ul>
<li><p>reset disable</p>
</li>
<li><p>Version Update enable</p>
</li>
<li><p>CheckSum</p>
</li>
</ul>
<img src="/2024/06/12/secure-boot/image-20240613192251191.png" class="">



<h2 id="romcode需要将整个secure-boot框架搭建好，会调用HSM进行校验"><a href="#romcode需要将整个secure-boot框架搭建好，会调用HSM进行校验" class="headerlink" title="romcode需要将整个secure boot框架搭建好，会调用HSM进行校验"></a>romcode需要将整个secure boot框架搭建好，会调用HSM进行校验</h2><h2 id="测试步骤（FPGA侧）"><a href="#测试步骤（FPGA侧）" class="headerlink" title="测试步骤（FPGA侧）"></a>测试步骤（FPGA侧）</h2><ol>
<li><p>确定使用rsa sm2 aes sm4使用哪种HSM算法</p>
<p>首先确定使用rsa sm2 aes sm4使用哪种算法，此时需要配置OTP的FW control SoC</p>
<img src="/2024/06/12/secure-boot/image-20240613202913302.png" class=""></li>
</ol>
<p>具体32bits对应的含义，如下：</p>
<img src="/2024/06/12/secure-boot/image-20240613203755205.png" class="">

<img src="/2024/06/12/secure-boot/image-20240613204224175.png" class="">



<ol start="2">
<li>更新HSM的秘钥</li>
</ol>
<p><font color=red>这个秘钥是指？作用是什么？</font>我理解是OTP的KEY区域</p>
<p>作用是让hsm romcode对hsm的firmware进行校验</p>
<ol start="3">
<li>更新固件</li>
</ol>
<p>因为HSM默认是没有固件的（dflash main区域的code）；可以backdoor的方式放进去</p>
<ol start="4">
<li>升级pflash usercode代码</li>
</ol>
<p>此时host的pflash侧是没有usercode，需要编译pflash usercode，并需要将此usercode烧录到pflash中；</p>
<p>此时还需要利用OSR的工具计算出一个签名值（可以选择用什么算法 计算签名），得到一个<code>签名值+head+usercode</code>的pack,一起烧录到pflash 中；</p>
<p>然后就能得到校验参数，需要烧写到pflash info区域；</p>
<ol start="5">
<li><p>烧写host romcode信息（烧写到flash进行模拟）</p>
</li>
<li><p>复位</p>
</li>
<li><p>读取pflash info校验参数</p>
</li>
<li><p>mail通信，调用hsm校验pflash user code</p>
</li>
<li><p>跳转到pflash user code执行</p>
</li>
</ol>
<h1 id="doc-eHSM-secure-boot-TRM"><a href="#doc-eHSM-secure-boot-TRM" class="headerlink" title="doc-&gt;eHSM secure boot TRM"></a>doc-&gt;eHSM secure boot TRM</h1><h2 id="Secure-Boot-Install-and-Upgrade"><a href="#Secure-Boot-Install-and-Upgrade" class="headerlink" title="Secure Boot, Install and Upgrade"></a>Secure Boot, Install and Upgrade</h2><p>The eHSM supports firmware stored in ROM, internal NVM or external NVM, </p>
<p>and also supports the firmware excuted in IROM, internal IRAM or internal NVM.  </p>
<p><font color=blue>This section describs one of the combinations that eHSM firmware is stored and excuted in internal NVM.</font></p>
<h3 id="eHSM-Secure-Boot-Install-and-Upgrade"><a href="#eHSM-Secure-Boot-Install-and-Upgrade" class="headerlink" title="eHSM Secure Boot, Install and Upgrade"></a>eHSM Secure Boot, Install and Upgrade</h3><p><font color=blue>eHSM Secure Boot: Verify eHSM firmware in NVM before excuting</font></p>
<p>•Verify the eHSM firmware image w&#x2F; ”eHSM FW Verify Key”</p>
<p>•Excute the code in NVM</p>
<p><font color=blue>eHSM Secure Install: Install eHSM firmware to NVM</font></p>
<p>•Decrypt and verify the eHSM firmware upgrade image w&#x2F; ”eHSM Upgrade Encrypt Key” and”eHSM Upgrade Verify Key”</p>
<p>•Sign the eHSM firmware code w&#x2F; ”eHSM FW Verify Key”</p>
<p>•Save the plaintext code image to NVM</p>
<p><font color=blue>eHSM Secure Upgrade: Upgrade eHSM firmware to NVM</font></p>
<p>•Similar flow as secure install</p>
<blockquote>
<p>一些思考：</p>
<p><font color=red>或者说install和upgrade的区别是什么?</font></p>
</blockquote>
<img src="/2024/06/12/secure-boot/image-20240614134053043.png" class="">



<h4 id="eHSM-Code-Location"><a href="#eHSM-Code-Location" class="headerlink" title="eHSM Code Location"></a>eHSM Code Location</h4><img src="/2024/06/12/secure-boot/image-20240614134651421.png" class="">



<h4 id="Encryption-Algorithm"><a href="#Encryption-Algorithm" class="headerlink" title="Encryption Algorithm"></a>Encryption Algorithm</h4><img src="/2024/06/12/secure-boot/image-20240614134840559.png" class="">



<h4 id="Encryption-OTP-Keys"><a href="#Encryption-OTP-Keys" class="headerlink" title="Encryption OTP Keys"></a>Encryption OTP Keys</h4><img src="/2024/06/12/secure-boot/image-20240614135113981.png" class="">



<h4 id="OTP-Algorithm-Selection-Field"><a href="#OTP-Algorithm-Selection-Field" class="headerlink" title="OTP Algorithm Selection Field"></a>OTP Algorithm Selection Field</h4><img src="/2024/06/12/secure-boot/image-20240614135258415.png" class="">



<h3 id="eHSM-Image-Format"><a href="#eHSM-Image-Format" class="headerlink" title="eHSM Image Format"></a>eHSM Image Format</h3><h4 id="eHSM-Image-Format-1"><a href="#eHSM-Image-Format-1" class="headerlink" title="eHSM Image Format"></a>eHSM Image Format</h4><p>The eHSM image includes code image and upgrade image</p>
<img src="/2024/06/12/secure-boot/image-20240614135539302.png" class="">



<h4 id="eHSM-Image-Fields-Definition"><a href="#eHSM-Image-Fields-Definition" class="headerlink" title="eHSM Image Fields Definition"></a>eHSM Image Fields Definition</h4><ul>
<li>Code Image Fields Definition</li>
</ul>
<img src="/2024/06/12/secure-boot/image-20240614161410855.png" class="">

<blockquote>
<p>Note:</p>
<p>•The ”Code_Signature” covers 432+254K bytes, from ”Code_Valid_Flag” to the end of the ”Code”</p>
</blockquote>
<ul>
<li>Upgrade Image Fields Definition</li>
</ul>
<img src="/2024/06/12/secure-boot/image-20240614161506218.png" class="">

<blockquote>
<p>Note:</p>
<p>•The ”Upgrade_Signature” covers 448+255K bytes data, including the whole upgrade imagefields except ”Upgrade_Signature” and ”Upgrade_Public_Key”.</p>
<p>•The whole 255K bytes code image is encrypted with ”eHSM_UPGRADE_ENC_KEY”</p>
</blockquote>
<h3 id="eHSM-Secure-Boot"><a href="#eHSM-Secure-Boot" class="headerlink" title="eHSM Secure Boot"></a>eHSM Secure Boot</h3><h4 id="Secure-Boot-Flow"><a href="#Secure-Boot-Flow" class="headerlink" title="Secure Boot Flow"></a>Secure Boot Flow</h4><ol>
<li><p>HW loads OTP information, decrypts OTP keys(Optional) and initializes system before releasingeHSM’s CPU reset</p>
</li>
<li><p>FW decryption and verification can be skipped in lifecycle ”TEST_MODE” and ”DEVELOP_MODE”,controlled by OTP control fields</p>
</li>
<li><p>eHSM will report error if there is no available FW code to info host and wait host to burn FW code through mailbox</p>
</li>
<li><p>eHSM will reports error if secure boot fails to info host and wait for host to debug through mailboxor UART port, including:</p>
<ol>
<li>(a)Crypto IP self-test fail</li>
<li>(b)Key (eHSM FW Verify Key) slot is not available</li>
<li>(c)Program (NVM code) verification fail</li>
<li>(d)Version number mismatch (OTP is newer than NVM)</li>
</ol>
</li>
</ol>
<img src="/2024/06/12/secure-boot/image-20240614162500741.png" class="">

<img src="/2024/06/12/secure-boot/image-20240614163102775.png" class="">

<img src="/2024/06/12/secure-boot/image-20240614163132301.png" class="">



<blockquote>
<p>Note:</p>
<ul>
<li><p>Program verification flow depends on the algorithm, it’s CMAC for symmetric algorithm and Hash &amp; RSA (or SM3 &amp; SM2) for asymmetric algorithm.</p>
</li>
<li><p>BOOTDONE_SUCCESS and BOOTDONE_FAIL means:</p>
<ul>
<li><p>BOOTDONE_SUCCESS: </p>
<ul>
<li><p>BOOTDONE&#x3D;1 and BOOTERR&#x3D;0</p>
</li>
<li><p>BOOTDONE_FAIL: BOOTDONE&#x3D;1 and BOOTERR&#x3D;1</p>
<p>Both BOOTDONE and BOOTERR are register fields in ”SYS_BOOT_STA”, and is routedto eHSM top output pin ”o_ehsm_status”The ”Report Error” is defined in EMU registers, and will be monitored through the eHSM’soutput pin ”o_ehsm_fw_err” by host</p>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>一些思考&amp;说明：</p>
<p><font color=red>crypto IP self test是什么意思？</font></p>
</blockquote>
<h4 id="Secure-Boot-Related-OTP-Fields"><a href="#Secure-Boot-Related-OTP-Fields" class="headerlink" title="Secure Boot Related OTP Fields"></a>Secure Boot Related OTP Fields</h4><img src="/2024/06/12/secure-boot/image-20240614163634621.png" class="">



<h3 id="eHSM-Secure-Install"><a href="#eHSM-Secure-Install" class="headerlink" title="eHSM Secure Install"></a>eHSM Secure Install</h3><h4 id="Secure-Install-Related-Keys"><a href="#Secure-Install-Related-Keys" class="headerlink" title="Secure Install Related Keys"></a>Secure Install Related Keys</h4><img src="/2024/06/12/secure-boot/image-20240614135113981.png" class="">



<h4 id="Secure-Install-Flow"><a href="#Secure-Install-Flow" class="headerlink" title="Secure Install Flow"></a>Secure Install Flow</h4><p>The secure install only contains following three steps:</p>
<h5 id="step1-Burn-install-FW-image-to-NVM"><a href="#step1-Burn-install-FW-image-to-NVM" class="headerlink" title="step1: Burn install FW image to NVM"></a>step1: Burn install FW image to NVM</h5><p>1.Burn <code>install FW image</code> to NVM</p>
<p>(a)Host prepares the FW install image and sends an INSTALL command to eHSM to start the FW install</p>
<p>(b)Once eHSM bootloader receives the INSTALL command, it starts following steps </p>
<p>​	i.Check the version with version counter in OTP</p>
<p>​	ii.Verify and decrypt the install image</p>
<p>​		(a) Verify the image with ”eHSM_UPGRADE_VERIFY_KEY”</p>
<p>​		(b)- For asymmetric algorithm</p>
<p>​				(i) Calculate the Hash of the image</p>
<p>​				(ii) Verify the signature of the image Hash value</p>
<p>​			- For symmetric algorithm</p>
<p>​				(i) Verify the signature of the image</p>
<p>​		(c)Decrypt the image with ”eHSM_UPGRADE_ENC_KEY”</p>
<p>​	iii.Compare the version counter between code image and upgrade image, report error if they are different</p>
<p>​	iv.(Optional) If Boot_Alg is symmetric algorithm: Calculate the code image MAC with”eHSM_VERIFY_KEY” and update the ”Code_Signature” field with the 		calculated MAC</p>
<blockquote>
<p>Note: This step is only needed when each part has its own ”eHSM_VERIFY_KEY”which is different from others’</p>
</blockquote>
<p>​	v.Write image to internal NVM</p>
<p>​	vi.Return command response with ”UPGRADE_DONE” (or corresponding error code)</p>
<h5 id="step2-Verify-installed-Program-in-NVM"><a href="#step2-Verify-installed-Program-in-NVM" class="headerlink" title="step2: Verify installed Program in NVM"></a>step2: Verify installed Program in NVM</h5><p>2.Verify installed Program in NVM</p>
<p>(a)Host sends VERIFY_PROGRAM command to start the program verification</p>
<p>(b)Once eHSM receives the VERIFY_PROGRAM command, it starts to verify the program inNVM, including</p>
<p>​	i.Compare the program version with OTP version counter</p>
<p>​	ii.Verify the program with ”eHSM_VERIFY_KEY”</p>
<p>​	iii.Return command response with ”REV_MATCH” or expected warning code ”REV_NEW”(Verification pass, but NVM program is newer than or same as OTP version counter)</p>
<h5 id="step3-Update-OTP-version-counter"><a href="#step3-Update-OTP-version-counter" class="headerlink" title="step3: Update OTP version counter"></a>step3: Update OTP version counter</h5><p>3.Update OTP version counter</p>
<p>(a)Host resets the eHSM</p>
<p>(b)Bootloader jumps to the internal NVM after verification</p>
<p>(c)eHSM runs the new FW.</p>
<p>(d)eHSM’s new FW always compare the image version with version counter in OTP, and burn the new version to OTP version counter bit filed if image version is newer than OTP versioncounter.</p>
<img src="/2024/06/12/secure-boot/image-20240614172128526.png" class="">

<img src="/2024/06/12/secure-boot/image-20240614172219853.png" class="">





<blockquote>
<p>Note:</p>
<p>•Upgrade algorithm field in OTP and image will be compared in ”Is Upgrade_Alg asymmetric?”step</p>
</blockquote>
<img src="/2024/06/12/secure-boot/image-20240614172334022.png" class="">

<img src="/2024/06/12/secure-boot/image-20240614172349477.png" class="">



<h3 id="eHSM-Secure-Upgrade"><a href="#eHSM-Secure-Upgrade" class="headerlink" title="eHSM Secure Upgrade"></a>eHSM Secure Upgrade</h3><h4 id="Secure-Upgrade-Related-Keys"><a href="#Secure-Upgrade-Related-Keys" class="headerlink" title="Secure Upgrade Related Keys"></a>Secure Upgrade Related Keys</h4><img src="/2024/06/12/secure-boot/image-20240614135113981.png" class="">



<h4 id="Secure-Upgrade-Flow"><a href="#Secure-Upgrade-Flow" class="headerlink" title="Secure Upgrade Flow"></a>Secure Upgrade Flow</h4><p>In order to avoid stopping eHSM secure service during upgrade, the upgrade image will be split into several segments, e.g., 4KB for each segment, and eHSM will verify, decrypt and encrypt eachsegment individually with Crypto IPs in interleave mode. The secure upgrade contains following three steps</p>
<h5 id="step1-Burn-Upgrade-FW-image-to-NVM"><a href="#step1-Burn-Upgrade-FW-image-to-NVM" class="headerlink" title="step1:Burn Upgrade FW image to NVM"></a>step1:Burn Upgrade FW image to NVM</h5><img src="/2024/06/12/secure-boot/image-20240614173335395.png" class="">

<img src="/2024/06/12/secure-boot/image-20240614173459441.png" class="">



<h5 id="step2-Verify-Upgrade-Program-in-NVM"><a href="#step2-Verify-Upgrade-Program-in-NVM" class="headerlink" title="step2:Verify Upgrade Program in NVM"></a>step2:Verify Upgrade Program in NVM</h5><img src="/2024/06/12/secure-boot/image-20240614174827334.png" class="">

<img src="/2024/06/12/secure-boot/image-20240614174907336.png" class="">



<h5 id="step3-Update-OTP-version-counter-1"><a href="#step3-Update-OTP-version-counter-1" class="headerlink" title="step3:Update OTP version counter"></a>step3:Update OTP version counter</h5><p>Same as secure install</p>
<img src="/2024/06/12/secure-boot/image-20240614172349477.png" class="">





<h3 id="SoC-Secure-Boot-Install-Upgrade"><a href="#SoC-Secure-Boot-Install-Upgrade" class="headerlink" title="SoC Secure Boot, Install &amp; Upgrade"></a>SoC Secure Boot, Install &amp; Upgrade</h3><h4 id="SoC-Secure-Boot-Install-Upgrade-Keys"><a href="#SoC-Secure-Boot-Install-Upgrade-Keys" class="headerlink" title="SoC Secure Boot, Install &amp; Upgrade Keys"></a>SoC Secure Boot, Install &amp; Upgrade Keys</h4><p>Similar to eHSM secure boot, image installation and upgrade, corresponding keys are needed forSoC secure boot, image installation and upgrade, including：</p>
<ul>
<li>SOC_ENC_KEY</li>
<li>SOC_VERIFY_KEY</li>
<li>SOC_UPGRADE_ENC_KEY</li>
<li>SOC_UPGRADE_VERIFY_KEY</li>
</ul>
<h4 id="SoC-Sequential-Parallel-Secure-Boot"><a href="#SoC-Sequential-Parallel-Secure-Boot" class="headerlink" title="SoC Sequential &amp; Parallel Secure Boot"></a>SoC Sequential &amp; Parallel Secure Boot</h4><p>There are two secure boot Strategies for SoC’s secure boot:</p>
<p>1.Sequential secure boot</p>
<ul>
<li>eHSM bootloader (ROM) verifies eHSM firmware</li>
<li>eHSM firmware verifies SoC bootloader</li>
<li>SoC bootloader calls eHSM’s secure service (e.g. by a specify command) to verify SoCfirmware</li>
</ul>
<p>2.Parallel secure boot</p>
<ul>
<li>eHSM bootloader (ROM) verifies eHSM firmware</li>
<li>SoC bootloader (ROM) calls eHSM’s secure service to verify SoC firmware</li>
</ul>
<blockquote>
<p>区别在于SoC的bootloader是否需要验证</p>
</blockquote>
<img src="/2024/06/12/secure-boot/image-20240617133007752.png" class="">





<p>The SoC boot strategy (sequential or parallel boot) is defined by the OTP field ”SocBootType”. </p>
<p>The boot and upgrade algorithms are also defined in OTP control fields.</p>
<p>eHSM first reads the configuration in OTP. If in sequential boot, eHSM firmware will verify the host directly. Otherwise, it waits for host to call interface to verify.</p>
<p>eHSM first reads the configuration in OTP. If in sequential boot, eHSM firmware will verify the hostdirectly. Otherwise, it waits for host to call interface to verify. No matter the verification is passed ornot, eHSM firmware just runs and offers the services. <font color=blue>The only difference is that soc_boot_erris setor not.</font></p>
<h4 id="SoC-Secure-Install-Upgrade"><a href="#SoC-Secure-Install-Upgrade" class="headerlink" title="SoC Secure Install &amp; Upgrade"></a>SoC Secure Install &amp; Upgrade</h4><p>The secure install &amp; upgrade for SoC bootloader or firmware could be very similar to the secureupgrade for eHSM firmware. The SoC’s bootloader or firmware image will be splinted into severalpieces and each will call corresponding eHSM mailbox commands (reuse eHSM upgrade commandsor new commands) to <font color=blue>decrypt, verify and encrypt</font> these image pieces to combine as the final encrypted code image for SoC.</p>
<blockquote>
<p>思考：</p>
<p>image为什么需要加密解密？</p>
<p>开发者如果想要开发程序，然后在SOTA升级的时候，为防止别人截获程序，需要使用密文传输，然后再进行解密，最后写到flash中。</p>
</blockquote>
<h3 id="eHsm-Single-Bank-Upgrade"><a href="#eHsm-Single-Bank-Upgrade" class="headerlink" title="eHsm Single Bank Upgrade"></a>eHsm Single Bank Upgrade</h3><p>Single Bank Upgrade Flow</p>
<img src="/2024/06/12/secure-boot/image-20240617151247080.png" class="">





<h1 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><p><font color=blue>Secure Boot install &amp; update有什么区别？</font></p>
<p>没什么太多的区别，install主要是一开始flash中没有数据；update主要是，flash中有数据之后，再进行更新</p>
<h1 id="secure-boot仿真build"><a href="#secure-boot仿真build" class="headerlink" title="secure boot仿真build"></a>secure boot仿真build</h1><p>更新OTP和FW</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/12/flash-SOTA%E8%AE%BE%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/12/flash-SOTA%E8%AE%BE%E8%AE%A1/" class="post-title-link" itemprop="url">flash SOTA设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-12 09:11:03 / 修改时间：10:25:30" itemprop="dateCreated datePublished" datetime="2024-06-12T09:11:03+08:00">2024-06-12</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%A6%E8%A7%84MCU/" itemprop="url" rel="index"><span itemprop="name">车规MCU</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/12/flash-SOTA%E8%AE%BE%E8%AE%A1/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/12/flash-SOTA%E8%AE%BE%E8%AE%A1/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>flash的SOTA设计是一种在线升级方案，这里简述下其工作机制。</p>
<p>SOTA即软件在线升级（Software updates Over The Air），是指在不连接烧写器的情况下，通过CAN、UART或其它通讯方式，实现应用程序的更新。</p>
</blockquote>
<h1 id="SOTA实现机制"><a href="#SOTA实现机制" class="headerlink" title="SOTA实现机制"></a>SOTA实现机制</h1><h2 id="常规实现方法"><a href="#常规实现方法" class="headerlink" title="常规实现方法"></a>常规实现方法</h2><p>在进行SOTA时，需要把旧的应用程序擦除，把新的应用程序写入。</p>
<p>常规的实现方式需要分别开发BootLoader程序和APP程序，MCU上电先运行BootLoader，BootLoader根据情况选择是否跳转到APP和是否进行程序更新。</p>
<p>具体来说有以下几种方式：</p>
<ul>
<li><p>方案一：更新程序时，由APP接收更新数据并暂存于Flash，再更改APP更新标志位；MCU重启时，BootLoader检查更新标志位，如有效，则擦除旧的APP，再将暂存于Flash的新APP数据写入APP运行地址处。<br>该方案的优点是更新数据的接收由APP完成，BootLoader不需要通讯协议栈，代码量更小，且数据传输中断时，原有APP不损坏。<br>缺点是需要额外的Flash空间暂存更新数据。</p>
</li>
<li><p>方案二：BootLoader中内置通讯协议栈，更新时，先向MCU发送指令使其跳转到BootLoader，之后先擦除旧APP，在接收新APP的同时直接将其写入Flash的APP运行地址处。<br>该方案的优点是不需要额外的Flash暂存数据。<br>缺点是BootLoader代码更复杂，且如果数据传输发生中断，旧的APP将不能被恢复。该方案更适合Flash容量较小的MCU。</p>
</li>
<li><p>方案三：将方案一和方案二相结合，即在BootLoader程序中内置通讯协议栈，更新时，先向MCU发送指令使其跳转到BootLoader，之后接收更新数据的时候，采用方案一的方法，先将数据暂存于Flash，待数据全部接收完成后再擦除旧的APP，写入新的APP。<br>该方案结合了方案一和方案二的优点，且能在没有APP或APP损坏的状态下实现程序更新。<br>缺点是BootLoader代码量更大，Flash空间占用更大。</p>
</li>
<li><p>方案四：在Flash中划分出两块相同大小的区域，分为A区和B区，都用来存放APP，但同一时间下只有一个区的APP是有效的，分别设置一个标志位标识其有效性。初始状态下先将APP写入A区，更新的时候，将新的APP写入B区，再把A区的APP擦除，同时更新两个区的有效性标志位状态。BootLoader中判断哪个区的APP有效，就跳转到哪个区运行。<br>这种方法优点不需要重复拷贝APP数据，但最大的一个缺点是AB区的APP程序运行地址不同，需要分别编译，从而使得可应用性大大降低。</p>
</li>
</ul>
<p>经过上面的分析，可以看出来每种方案都有其优缺点，对于Flash容量较小的MCU，通常采用方案二，因为没有过多的空间暂存APP更新数据。但对于MCU的Flash容量很大的，通常要先把APP暂存下来再进行更新，防止数据传输中断导致APP不可用。上面的方案一、三、四都能实现，但并不完美。</p>
<p><font color=blue>如果实现的SOTA机制更类似于方案四，且Flash支持两种地址映射方式，从而使得APP编译时不需要区分AB区，使用相同的地址即可，从而避免了方案四的硬伤，就可以提供一种最佳的SOTA方案，下面描述的就是此种实现方法</font></p>
<h2 id="项目实现方法"><a href="#项目实现方法" class="headerlink" title="项目实现方法"></a>项目实现方法</h2><p>程序上不用对地址做改动，硬件做地址映射</p>
<img src="/2024/06/12/flash-SOTA%E8%AE%BE%E8%AE%A1/image-20240612095815405.png" class="">

<p>在升级的时候（假设当前程序运行在bank0，<code>bank0处于0x0020_000,bank1处于0x0040_0000</code>）：</p>
<p>1、先擦除bank1的内容</p>
<p>2、更新新的APP到bank1</p>
<p>3、更新SOTA swap参数</p>
<p>4、复位，对SOTA swap参数解析，rom code跳转到bank1（<code>bank1处于0x0020_0000,bank0处于0x0040_0000</code>）执行</p>
<hr>
<p>参考博客：</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014157109/article/details/121006232">SOTA机制详解</a></li>
</ol>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/11/3-AMBA-AHB-APB/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/11/3-AMBA-AHB-APB/" class="post-title-link" itemprop="url">3 AMBA/AHB/APB（1）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-11 21:26:50" itemprop="dateCreated datePublished" datetime="2024-06-11T21:26:50+08:00">2024-06-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-07-12 10:15:42" itemprop="dateModified" datetime="2024-07-12T10:15:42+08:00">2024-07-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%BA%E4%BA%8ECortex-M%E7%9A%84SoC%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">基于Cortex-M的SoC设计</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/11/3-AMBA-AHB-APB/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/11/3-AMBA-AHB-APB/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="What-is-AMBA"><a href="#What-is-AMBA" class="headerlink" title="What is AMBA?"></a>What is AMBA?</h1><h2 id="Introduction-to-Advanced-Microcontroller-Bus-Architecture"><a href="#Introduction-to-Advanced-Microcontroller-Bus-Architecture" class="headerlink" title="Introduction to Advanced Microcontroller Bus Architecture"></a>Introduction to Advanced Microcontroller Bus Architecture</h2><h2 id="History-of-AMBA"><a href="#History-of-AMBA" class="headerlink" title="History of AMBA"></a>History of AMBA</h2><h2 id="Various-versions-of-AMBA-specification"><a href="#Various-versions-of-AMBA-specification" class="headerlink" title="Various versions of AMBA specification"></a>Various versions of AMBA specification</h2><h1 id="Overview-of-AHB"><a href="#Overview-of-AHB" class="headerlink" title="Overview of AHB"></a>Overview of AHB</h1><h2 id="Various-versions-of-AHB"><a href="#Various-versions-of-AHB" class="headerlink" title="Various versions of AHB"></a>Various versions of AHB</h2><h2 id="AHB-signals"><a href="#AHB-signals" class="headerlink" title="AHB signals"></a>AHB signals</h2><h2 id="Basic-operations"><a href="#Basic-operations" class="headerlink" title="Basic operations"></a>Basic operations</h2><hr>
<p>&#x3D;&#x3D;》 组件的连接</p>
<p>在单Master和多Slave的简单设计中，AHB总线系统可以按照下图设计：</p>
<img src="/2024/06/11/3-AMBA-AHB-APB/image-20240611215804055.png" class="">

<p><font color=red>1、data phase mux control?什么意思？怎么实现？</font></p>
<p><font color=red>2、一般接触到的hready应该是将所有的hreadyout信号进行与操作实现</font></p>
<p><font color=red>这两种方式均可</font></p>
<p>如果遵循<code>AMBA 5 AHB</code>规范，可以按照如下方式连接：</p>
<ul>
<li>多个<code>AHB Master</code>共享一个bus，需要使用<code>Master Multiplexer</code>和<code>Master arbiter</code>，arbiter仲裁之后产生选通信号，通过Multiplexer选通，占用总线</li>
<li>多个<code>AHB Slave</code>返回的data和response信号需要使用<code>Slave Multiplexer</code> feedback to <code>AHB Master</code>，其中Slave Multiplexer通过Decoder产生的信号进行选通</li>
</ul>
<hr>
<p>&#x3D;&#x3D;》信号基本时序</p>
<p>信号可以被划分为<code>address phase singals </code>和<code>data phase singals  </code>：</p>
<p><code>address phase</code> signals include:</p>
<ul>
<li>HADDR, HTRANS, HSEL, HWRITE, HSIZE.</li>
<li>Optional: HPROT, HBURST, HMASTLOCK, HEXCL, HAUSER</li>
</ul>
<p><code>data phase</code> signals include:</p>
<ul>
<li><p>HWDATA, HRDATA, HRESP, HREADY (and HREADYOUT).</p>
</li>
<li><p>Optional: HEXOKAY, HWUSER, HRUSER.</p>
</li>
</ul>
<p><font color=blue>每一个transfer都是有address phase和data phase</font></p>
<p><font color=blue>transfer是pipelined，意味着当前transfer的address phase可以和上一次transfer的data phase overlap</font></p>
<img src="/2024/06/11/3-AMBA-AHB-APB/image-20240611221656976.png" class="">

<hr>
<p>&#x3D;&#x3D;》data phase select control生成</p>
<blockquote>
<p>Each phase is terminated by the assertion of HREADYOUT (HREADY) from <code>the currently activated AHB slave in the data phase</code>. </p>
<p>The HREADYOUT from the AHB slaves are multiplexed by the slave multiplexer, forming the system-wide HREADY signal.</p>
<p> The multiplexer is operating at the data phase of each transfer. Control of the multiplexer can be generated from the AHB decoder, or the HSEL<br>signals and the HREADY signal.  </p>
</blockquote>
<p>结合上面的波形图，来理解这段话：</p>
<blockquote>
<p>如果当前看的是Address Phase N，则当前有效的ahb slave data phase 就是上图的data phase(N-1)；</p>
<p>hreadyout通过slave multiplexer形成了系统范围的HREADY信号；</p>
<p>slave multiplexer在一个transfer的data phase进行mux，现在问题就是如何生成slave multiplexer的控制信号data phase select？</p>
<p>&#x3D;&#x3D;》通过HSEL以及HREADY信号</p>
</blockquote>
<img src="/2024/06/11/3-AMBA-AHB-APB/image-20240611223909464.png" class="">



<blockquote>
<p>If an AHB slave is not currently selected, its HREADYOUT should be high to indicate it is ready.<br>However, it can only accept a transfer from the bus master when the previous transfer is completed,<br>indicated by a high level in the system-wide HREADY.   </p>
<p>注意两个词语，结合下面的波形图理解：</p>
<p>(Address  phase)  AHB Slave A selected</p>
<p>(Data pahse       )  AHB Slave A active</p>
<p>以Slave B为例，如果开始时，Slave B未被选中进行transfer，那么下次Slave B的transfer需要等到系统范围的HREADY HIGH才可以进行；</p>
</blockquote>
<img src="/2024/06/11/3-AMBA-AHB-APB/image-20240612222936437.png" class="">



<h2 id="Minimal-AHB-systems"><a href="#Minimal-AHB-systems" class="headerlink" title="Minimal AHB systems"></a>Minimal AHB systems</h2><p>最小的AHB system有一个bus master，多个bus slave以及接下来的AHB 组件：</p>
<img src="/2024/06/11/3-AMBA-AHB-APB/image-20240612225507780.png" class="">



<p>address decoder应根据系统的memory map进行设计，HSEL是一个地址阶段的信号，由HADDR通过组合逻辑产生，其不应该有复杂的decode逻辑，否则综合的时候timing会受到影响；</p>
<p>AHB slave multiplexer会更加通用一点，而且能够在各种ARM AHB IP bundles中找到。不同的AHB Slave有着不同的read data outputs和response outputs，因此需要一个Slave Multiplexer 在current active slave阶段返回data和response；</p>
<p>AHB Slave multiplexer是被一个<code>data phase版本的HSEL信号</code>控制(对address phase的HSEL做一级pipelline)。具体的实现方法是，利用系统范围的HREADY信号做使能，然后对HSEL寄存一拍（可以参考前文的原理图）；<font color=blue>大多数情况下，HSEL的寄存行为是在AHB Slave Muxplexer中做的，所以Designer可以直接将地址阶段的HSEL信号连接到AHB Slave Multiplexer即可；</font></p>
<p>AHB system中可能由多个decoder和AHB Slave Multiplexer。AHB system有多个AHB subsystem，各自包含了一块地址空间。在这样的场景下，子系统的decoder可能就要考虑到顶层decoder的HSEL信号，如下图所示：</p>
<img src="/2024/06/11/3-AMBA-AHB-APB/image-20240613230353912.png" class="">



<h2 id="Handling-of-multiple-bus-masters"><a href="#Handling-of-multiple-bus-masters" class="headerlink" title="Handling of multiple bus masters"></a>Handling of multiple bus masters</h2><hr>
<p>&#x3D;&#x3D;》如果是基于AMBA2规范的AHB协议，多个AHB Master和AHB Slave之间的连接关系如下图所示：</p>
<img src="/2024/06/11/3-AMBA-AHB-APB/image-20240613230916059.png" class="">

<blockquote>
<p>多个AHB Master通过Master multiplexer共享同一个总线，由master arbiter仲裁产生控制信号；</p>
<p>read data和response通过Slave multiplexer返回，由decoder产生控制信号；</p>
<p>在Master发出transfer之前，首先通过<code>HBUSREQ (Bus Request) </code>以及<code>HGRANT (Bus Granted)  </code>信号和Master arbiter进行handshaking</p>
<ol>
<li>A bus master must first assert a bus request (HBUSREQ) to the arbiter, then</li>
<li>After arbitration, the arbiter returns the bus granted signal (HGRANT) to one of the bus masters, then</li>
<li>The bus master can then generate transfers on the bus.</li>
<li>If the HGRANT signal is de-asserted, the bus master must stop issuing new transfers.</li>
</ol>
</blockquote>
<hr>
<p>&#x3D;&#x3D;》<font color=blue>简单的AHB系统可以根据这种规则进行工作，但是如果是复杂的场景，BUS带宽就会受到限制，因为BUS上同时只能有一个Master和一个Slave进行通信；</font></p>
<p><font color=blue><code>AMBA Design Kit (ADK) </code>产品有了一种新的技术（<code>multi-layer AHB</code>）去支持多个AHB Master同时使用总线的场景；</font></p>
<p>ADK的<code>BusMatrix IP</code>是一个<code>AHB interconnect</code>组件（使用的是multi-layer AHB技术）,即支持多个Master和多个Slave互联；</p>
<p>如果有多个AHB Slave需要连接到总线，但是总线资源有限的情况下，可以在BusMatrix外面使用额外的Slave Muxplexer进行扩展；</p>
<img src="/2024/06/11/3-AMBA-AHB-APB/image-20240613234213952.png" class="">

<p>可以看到，BusMatrix IP<font color=blue>为了解决多个bus master去访问同一个bus slave时的冲突</font>，每个master port（connects to bus slave）都有一个arbiter；</p>
<p>如果某一个bus masterA想要传输数据到某个bus slave，但是此bus slave正在被另外一个bus masterB访问，那么bus masterA的transfer会保存到input stage的buffer中；在这种情形下，HBUSREQ 和HGRANT 就不再需要了；</p>
<blockquote>
<p>一些思考：</p>
<p>1，原来的HBUSREQ 和HGRANT是为了解决多个bus master去访问同一个bus slave的场景；</p>
<p>现在使用input stage之后，transfer会被缓存到input stage中；就不会造成冲突，因此就不需要HBUSREQ 和HGRANT</p>
<p>2，文中只说明了一个bus masterB已经访问了bus slave，然后在访问期间，另外一个bus masterA有来访问bus slave的情况；如果是两个bus Master同时访问同一个bus Slave，处理的情况也是类似的；都会经过arbiter仲裁，然后有一个bus master transfer会被缓存到input stage；</p>
<p>3，如果bus masterA的transfer的被缓存到input stage中，此时slave port（connect to bus masterA）hreadyout应该是拉低的，此时bus masterA会hold<font color=red>这一步transfer吗?如果会的话，为什么要缓存？直接返回hreadyout，然bus MasterA一直hold不可以吗？</font></p>
</blockquote>
<p><font color=blue>bus matrix的这种设计允许不同的master同时访问不同的slave，增强了系统带宽的处理能力</font></p>
<p>bus matrix IP可以在<code>AMBA Design Kit(ADK)</code>以及<code>Cortex-M System Design Kit(CMSDK)</code>中配置使用；AHB BusMatrix IP是<code>Corstone foundation IP</code> &#x2F; <code>CoreLink SDK (System Design Kit)  </code>的一部分。</p>
<hr>
<p>针对系统带宽要求不高的场景，可以使用类似于AMBA 2 AHB的架构，如下图所示，其利用了一个重新设计的AHB Master Multiplexer, 内部包括了<code>internal input state以及internal arbiter(可以看成是Bus Matrix，只不过只有一个slave，因此不需要internel address decoder)</code></p>
<img src="/2024/06/11/3-AMBA-AHB-APB/image-20240615234302205.png" class="">



<p><font color=red>需要研究下AHB组件 Slave Mux IP 的HSEL信号一级HREADYOUTx，HREADY实现</font></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/11/python%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/11/python%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/" class="post-title-link" itemprop="url">python基础语法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-11 15:01:33" itemprop="dateCreated datePublished" datetime="2024-06-11T15:01:33+08:00">2024-06-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-17 12:15:47" itemprop="dateModified" datetime="2024-06-17T12:15:47+08:00">2024-06-17</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ip%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" itemprop="url" rel="index"><span itemprop="name">ip开发环境搭建</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ip%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/python%E8%84%9A%E6%9C%AC/" itemprop="url" rel="index"><span itemprop="name">python脚本</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/11/python%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/11/python%E5%9F%BA%E7%A1%80%E8%AF%AD%E6%B3%95/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="条件分支"><a href="#条件分支" class="headerlink" title="条件分支"></a>条件分支</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> condition1:</span><br><span class="line">    <span class="comment"># statement1</span></span><br><span class="line"><span class="keyword">elif</span> condition2:</span><br><span class="line">    <span class="comment"># statement2</span></span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="comment">#statement3</span></span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/07/verilog%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/07/verilog%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/" class="post-title-link" itemprop="url">verilog条件编译</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-07 11:38:37" itemprop="dateCreated datePublished" datetime="2024-06-07T11:38:37+08:00">2024-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-09-09 20:48:55" itemprop="dateModified" datetime="2024-09-09T20:48:55+08:00">2024-09-09</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/verilog%E8%AF%AD%E6%B3%95/" itemprop="url" rel="index"><span itemprop="name">verilog语法</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/07/verilog%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/07/verilog%E6%9D%A1%E4%BB%B6%E7%BC%96%E8%AF%91/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/07/%E8%BD%A6%E8%A7%84MCU-bootrom-%E9%AA%8C%E8%AF%81/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/07/%E8%BD%A6%E8%A7%84MCU-bootrom-%E9%AA%8C%E8%AF%81/" class="post-title-link" itemprop="url">车规MCU bootrom 验证</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-07 10:36:27" itemprop="dateCreated datePublished" datetime="2024-06-07T10:36:27+08:00">2024-06-07</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-11 14:41:04" itemprop="dateModified" datetime="2024-06-11T14:41:04+08:00">2024-06-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%A6%E8%A7%84MCU/" itemprop="url" rel="index"><span itemprop="name">车规MCU</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/07/%E8%BD%A6%E8%A7%84MCU-bootrom-%E9%AA%8C%E8%AF%81/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/07/%E8%BD%A6%E8%A7%84MCU-bootrom-%E9%AA%8C%E8%AF%81/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>车规MCU需要HSM信息安全，其实现方式有可能会利用到host bootrom</p>
<p>一个不懂的东西，怎么去快速了解上手？</p>
<p>1、需要自己看看已有的资料有一定的认知；</p>
<p>2、私下问下同事，询问不懂的问题；</p>
<p>2、开会和其他同事同步，进一步加深理解；</p>
<p>3、总结思考实践–&gt;有自己的认知；</p>
</blockquote>
<h1 id="host-bootrom功能描述"><a href="#host-bootrom功能描述" class="headerlink" title="host bootrom功能描述"></a>host bootrom功能描述</h1><p>主要提供normal boot和secure boot的功能</p>
<p>BootRom需要使用GPIO，Uart，HSM message box等模块。</p>
<h1 id="测试流程"><a href="#测试流程" class="headerlink" title="测试流程"></a>测试流程</h1><p>&#x3D;&#x3D;》load config只是从flash info区域读取数据，不care OTP区域；</p>
<p><font color=blue>hsm enable以及secure boot是通过读取寄存器</font>？也不用care OTP区域；</p>
<p><font color=red>读取寄存器？读取什么寄存器？</font></p>
<p>&#x3D;&#x3D;》init debug表明是否需要打印log（optional，默认disable）</p>
<p>要打印log就初始化UART串口；不需要打印log就不初始化UART串口；</p>
<p>&#x3D;&#x3D;》rom code的执行是否需要切换成系统时钟（optional，默认enable）</p>
<p>切换成PLL提供的系统时钟，处理速度就比较快，加速启动时间</p>
<p>启动PLL也就是初始化PLL大概需要100us的时间</p>
<p><font color=red>系统时钟：从什么时钟切换到PLL时钟？？？</font></p>
<h2 id="non-security-boot"><a href="#non-security-boot" class="headerlink" title="non-security boot"></a>non-security boot</h2><p>&#x3D;&#x3D;》两个secure boot check？</p>
<p>security boot分成两部分：一个是启动校验，一个是等待校验结果</p>
<p>所以流程图上有两个security boot check框</p>
<p>&#x3D;&#x3D;》Restore debug and clock(Optional)</p>
<p>关闭UART以及将系统时钟切回去</p>
<p>&#x3D;&#x3D;》jump to user code</p>
<p>跳转到pflash的user code（default是0x20_0000）</p>
<ul>
<li><p>user code可以配置从pflash的info区域执行；</p>
</li>
<li><p>user code可以配置从pflash的main区域执行；</p>
</li>
</ul>
<p>执行user code</p>
<h2 id="security-boot"><a href="#security-boot" class="headerlink" title="security boot"></a>security boot</h2><p>&#x3D;&#x3D;》 security boot需要很多的配置信息，首先需要确认配置信息是否正确（主要是对地址以及size的有效性进行检查）</p>
<p>&#x3D;&#x3D;》等待HSM ready</p>
<p>&#x3D;&#x3D;》执行check code（<font color=blue>校验用户代码的代码</font>），通过发命令到HSM，（主要是校验地址，校验size以及校验算法），让其开始校验<font color=blue>用户代码</font></p>
<p>&#x3D;&#x3D;》等待check结果（done，pass&#x2F;fail）</p>
<p>正确就继续执行下面的流程，即走启动用户代码的流程；</p>
<p>错误就执行while 1 （default的行为），也可配置成system reset，通过watch dog进行复位；</p>
<p>吴奎那边有现成的工具可以做对应的测试；</p>
<h1 id="Q-A"><a href="#Q-A" class="headerlink" title="Q&amp;A"></a>Q&amp;A</h1><p>&#x3D;&#x3D;》什么时候出现check error</p>
<p>将需要校验的代码，手动修改成错误数据</p>
<blockquote>
<p>校验算法是通过OTP配置好的</p>
<p>校验的地址和size都是在info区域配置的</p>
</blockquote>
<p>&#x3D;&#x3D;》standby boot</p>
<p>pflash user code进入standby模式之后，默认还会执行security boot校验（optional可配置）</p>
<p>&#x3D;&#x3D;》用户代码和被校验的代码</p>
<p>安全启动的时候就是被校验的代码</p>
<p>没有安全启动的时候就是未被校验的代码，即用户代码</p>
<p>&#x3D;&#x3D;》默认是不swap的</p>
<p>swap之后，如下图这些配置起始地址就会从0x01004800–&gt;0x01005000，offset不变</p>
<img src="/2024/06/07/%E8%BD%A6%E8%A7%84MCU-bootrom-%E9%AA%8C%E8%AF%81/image-20240611113255222.png" class="">



<p>&#x3D;&#x3D;》security boot的参数比较多</p>
<p>hsm security boot的各个参数是绑定到一起的，通常来说错一个都会导致HSM check error</p>
<p>&#x3D;&#x3D;》SOTA功能测试</p>
<p>有两个配置区域，一个是正确的配置，一个是错误的配置；</p>
<p>通过配置SOTA enable还是disable可以进行不同的测试；</p>
<p>&#x3D;&#x3D;》HSM安全启动测试</p>
<p>不同的校验算法都校验成功；</p>
<p>根据hsm的算法，去校验什么东西，然后做对应的配置；</p>
<p>询问HSM的人，怎么把算法用起来；</p>
<p>例如：key需要配置什么东西，验签signature需要设置什么东西和算法相关，使用什么算法，就需要根据对应的算法做相应的配置</p>
<h2 id="pflash-info-HSM-security-boot各项配置参数的含义"><a href="#pflash-info-HSM-security-boot各项配置参数的含义" class="headerlink" title="pflash info:HSM security boot各项配置参数的含义"></a>pflash info:HSM security boot各项配置参数的含义</h2><h2 id="dflash-info-OTP各项配置参数的含义"><a href="#dflash-info-OTP各项配置参数的含义" class="headerlink" title="dflash info:OTP各项配置参数的含义"></a>dflash info:OTP各项配置参数的含义</h2><h2 id="SOTA机制"><a href="#SOTA机制" class="headerlink" title="SOTA机制"></a>SOTA机制</h2><h2 id="boot-flow-数据流"><a href="#boot-flow-数据流" class="headerlink" title="boot flow&#x2F;数据流"></a>boot flow&#x2F;数据流</h2><p>例如，host core先动起来，执行host romcode代码，然后加载pflash info区域的值；</p>
<p>然后判断是否为security boot，如果是的话，发送command，去调动hsm做校验；</p>
<p><font color=red>hsm根据OTP的value去使用相应的算法做校验？？？具体的流程是什么样？</font></p>
<h2 id="测试item"><a href="#测试item" class="headerlink" title="测试item"></a>测试item</h2><p>配置选项&#x2F;输入条件</p>
<p>check point？</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Youngster"
      src="/images/animal_toy_cute_doll_teddy_256.png">
  <p class="site-author-name" itemprop="name">Youngster</p>
  <div class="site-description" itemprop="description">show me bug</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">140</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">138</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Youngster</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '3qPpN2UkBU7Q1vhWnH1WdrQZ-gzGzoHsz',
      appKey     : 'LAapaVzfFkIj1knpaWSWCNDo',
      placeholder: "Looking forward to communication.",
      avatar     : 'monsterid',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
