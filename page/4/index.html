<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.1.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/animal_toy_cute_doll_teddy_72.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/animal_toy_cute_doll_teddy_72.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"wzjsdyx.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="show me bug">
<meta property="og:type" content="website">
<meta property="og:title" content="芯青年">
<meta property="og:url" content="https://wzjsdyx.github.io/page/4/index.html">
<meta property="og:site_name" content="芯青年">
<meta property="og:description" content="show me bug">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Youngster">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://wzjsdyx.github.io/page/4/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-CN'
  };
</script>

  <title>芯青年</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">芯青年</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/07/02/security%E4%B9%8B%E7%89%88%E6%9C%AC%E5%8F%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/02/security%E4%B9%8B%E7%89%88%E6%9C%AC%E5%8F%B7/" class="post-title-link" itemprop="url">security之版本号</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-07-02 23:09:12 / 修改时间：23:16:34" itemprop="dateCreated datePublished" datetime="2024-07-02T23:09:12+08:00">2024-07-02</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E8%BD%A6%E8%A7%84MCU/" itemprop="url" rel="index"><span itemprop="name">车规MCU</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/07/02/security%E4%B9%8B%E7%89%88%E6%9C%AC%E5%8F%B7/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/07/02/security%E4%B9%8B%E7%89%88%E6%9C%AC%E5%8F%B7/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>hsm 校验的时候会确认版本号；</p>
<p>版本号的作用是防止rollback，也就是说必须确保历史版本不能被再次升级到芯片中；</p>
<blockquote>
<p>升级的目的通常是解决之前的程序bug，</p>
<p>如果之前版本的程序有bug，被发现了漏洞，然后又被再次升级到芯片中，那么此时的芯片就不是安全的；</p>
<p>版本号检查就是为了阻止这种问题；</p>
</blockquote>
<p>hsm 厂商针对版本号检查的逻辑是：</p>
<p>1、首先校验用户程序，</p>
<p>2、校验通过之后再进行版本号检查</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/" class="post-title-link" itemprop="url">6 Low-power support（1）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-02 20:49:45" itemprop="dateCreated datePublished" datetime="2024-07-02T20:49:45+08:00">2024-07-02</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-07-30 09:53:35" itemprop="dateModified" datetime="2024-07-30T09:53:35+08:00">2024-07-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%BA%E4%BA%8ECortex-M%E7%9A%84SoC%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">基于Cortex-M的SoC设计</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%BA%E4%BA%8ECortex-M%E7%9A%84SoC%E8%AE%BE%E8%AE%A1/%E7%90%86%E8%AE%BA%E7%9F%A5%E8%AF%86%EF%BC%9A%E5%9F%BA%E4%BA%8ECortex-M%E7%9A%84SoC%E8%AE%BE%E8%AE%A1%E6%8C%87%E5%8D%97/" itemprop="url" rel="index"><span itemprop="name">理论知识：基于Cortex-M的SoC设计指南</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Overview-of-low-power-Cortex-M-features"><a href="#Overview-of-low-power-Cortex-M-features" class="headerlink" title="Overview of low-power Cortex-M features"></a>Overview of low-power Cortex-M features</h1><p>现在的MCU追究非常机制的能效比；</p>
<p><font color=blue>Cortex-M系列处理器提供了很多的低功耗特性：</font></p>
<ul>
<li>sleep mode：sleep mode和deep sleep mode</li>
<li>多个模块级别的时钟门控，以及子模块级别的时钟门控（有些时候也称为架构门控时钟）</li>
<li>状态保持电源门口SRPG（State retention power gating  ）</li>
<li>WIC</li>
<li>sleep-on-exit：应用在中断驱动的场景中</li>
</ul>
<p><font color=blue>Cortex-M系列处理器还有很多能降低功耗的优点：</font></p>
<ul>
<li>代码密度高：降低存储空间要求；</li>
<li>core的面积小：门数少</li>
<li>性能优，程序执行的快，减少运行时间；</li>
<li>低中断延时以及中断处理优化：能够降低中断处理时的功耗</li>
</ul>
<p><font color=blue>还有些系统级别的低功耗策略：</font></p>
<p>例如将SRAM分成多个bank，某些场景下关闭不用的bank，来降低功耗；</p>
<h1 id="Low-power-design-basics"><a href="#Low-power-design-basics" class="headerlink" title="Low-power design basics"></a>Low-power design basics</h1><h2 id="clock-gating"><a href="#clock-gating" class="headerlink" title="clock gating"></a>clock gating</h2><p>时钟门控clock gating是最基本的低功耗技术之一。</p>
<h3 id="寄存器级别的时钟门控："><a href="#寄存器级别的时钟门控：" class="headerlink" title="寄存器级别的时钟门控："></a>寄存器级别的时钟门控：</h3><p>综合工具会将使能信号综合成寄存器时钟门控，对Verilog RTL的代码风格有要求</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240709093742706.png" class="">

<p><font color=blue></font></p>
<h3 id="模块级别的时钟门控"><a href="#模块级别的时钟门控" class="headerlink" title="模块级别的时钟门控"></a>模块级别的时钟门控</h3><p><font color=blue></font></p>
<p>处理器内部各个功能模块的时钟信号受到时钟门控，通过例化时钟门控CELL，这种做法也叫做ACG（architectural clock gating  ）；</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240709094847853.png" class="">



<p>很多的Cortex-M处理器有多个top_level级别的时钟信号，designer需要自行添加时钟门控；</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240709095233535.png" class="">

<blockquote>
<p>可以使用debug power control signals CDBGPWRUPREQ and CDBGPWRUPACK  去门控debug CLK</p>
<p>可以使用GATEHCLK signal   去门控system CLK</p>
</blockquote>
<h2 id="power-gating"><a href="#power-gating" class="headerlink" title="power gating"></a>power gating</h2><p>有些场景下仅仅关闭时钟还是无法满足低功耗场景的要求，这时就可以考虑power gating；</p>
<p>power gating技术需要：</p>
<ul>
<li>power switch transistors  </li>
<li>isolation  cell</li>
<li>clamping  cell</li>
</ul>
<blockquote>
<p><strong>电源开关晶体管 (Power Switch Transistors)</strong>:</p>
<ul>
<li>这些晶体管用于实现电源门控，即通过控制它们的通断来控制电路的电源供应。当电源开关晶体管关闭时，相关电路部分与电源完全隔离，以减少静态功耗。</li>
</ul>
<p><strong>信号隔离 (Signal Isolation)</strong>:</p>
<ul>
<li>在电源门控中，关闭电源时，需要确保电路输入和输出信号不会影响其他部分。为了实现这一点，通常会使用专门的电路单元或电路设计技巧，如电流隔离器或传输门，以保持断开电源时的信号完整性和稳定性。</li>
</ul>
<p><strong>信号夹持 (Signal Clamping)</strong>:</p>
<ul>
<li>电源门控时，有时需要对电路输入或输出信号进行夹持，以防止信号超过安全电压范围。夹持电路通常包括二极管或其他电路元件，用于限制信号的振幅或保护相关电路部分不受损坏。</li>
<li>信号夹持就是将对外的value输出为high或者low</li>
</ul>
</blockquote>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240709100104211.png" class="">

<h3 id="SRPG（State-Retention-Power-Gating-）"><a href="#SRPG（State-Retention-Power-Gating-）" class="headerlink" title="SRPG（State Retention Power Gating  ）"></a>SRPG（State Retention Power Gating  ）</h3><p><font color=blue></font></p>
<p>power gating的一个最大的缺点就是掉点后状态会丢失，为了解决这个问题，引入了新的技术，SRPG（State Retention Power Gating  ），其在寄存器内部引入状态保持的逻辑，并且使用独立的电源供电。</p>
<ul>
<li>寄存器除了状态保持部分，其余部分均会掉电，因此也会节省很多功耗；</li>
<li>funciton功能下，此种寄存器的功耗比普通寄存器的功耗更高，因此不适合经常toggle的寄存器；</li>
</ul>
<h2 id="其他低功耗技术"><a href="#其他低功耗技术" class="headerlink" title="其他低功耗技术"></a>其他低功耗技术</h2><p>纯粹的数字逻辑一般会用到上述的低功耗技术。在其他方面还有低功耗技术，例如</p>
<ul>
<li>memory macro的低功耗技术；</li>
<li>外设组件，例如ADC有其自身特有的低功耗技术</li>
</ul>
<h1 id="Cortex-M-low-power-interfaces"><a href="#Cortex-M-low-power-interfaces" class="headerlink" title="Cortex-M low-power interfaces"></a>Cortex-M low-power interfaces</h1><h2 id="Sleep-status-and-GATEHCLK-output"><a href="#Sleep-status-and-GATEHCLK-output" class="headerlink" title="Sleep status and GATEHCLK output"></a>Sleep status and GATEHCLK output</h2><p><font color=blue>大多数的Cortex-M处理器具有如下的低功耗状态输出信号：</font></p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240712094613888.png" class="">

<hr>
<p><font color=blue>&#x3D;&#x3D;》SLEEPING和SLEEPDEEP信号的说明</font></p>
<p>从架构上来说，处理器支持两种睡眠模式，sleep mode和deep sleep mode。</p>
<p>进入这两种睡眠模式的机制是相同的：</p>
<p>1、首先执行WFI或者WFE；</p>
<p>2、启用了sleep-on-exit   特性，处理器从异常处理程序返回到线程级别；</p>
<blockquote>
<p>思考：</p>
<p>这里关于sleep-on-exit信号是不是说错了？sleep-on-exit特性使能的时候，中断处理结束会直接进入sleep mode。</p>
</blockquote>
<p>Cortex-M处理器进入哪种睡眠模式，根据SCR（System Control Register  ）的配置。</p>
<p>处理器内部对这两种模式的处理是相同的，SLEEP和SLEEPDEEP信号的作用是，让system designer去定义系统级的低功耗策略。</p>
<p>WIC只在deepsleep mode的时候才会使用；</p>
<hr>
<p><font color=blue>&#x3D;&#x3D;》GATEHCLK信号的说明</font></p>
<p>当处理器是处于睡眠模式的时候，处理器的AHB-Lite总线接口仍然可能发出debug access访问；</p>
<p>因此，就需要一个额外的GATEHCLK信号用来表示处理器处于睡眠状态，并且此时没有AHB-Lite总线访问（例如debug access导致的AHB-Lite transaction）。</p>
<hr>
<p>以上这些信号的使用特定于MCU，没有固定的使用规则；</p>
<p>例如，如果GATEHCLK信号是高电平的时候，可以：</p>
<ul>
<li><p>将系统BUS clock gate off</p>
</li>
<li><p>SRAM进入低功耗模式</p>
</li>
<li><p>部分外设被关闭；</p>
</li>
</ul>
<h2 id="Q-channel-low-power-interface"><a href="#Q-channel-low-power-interface" class="headerlink" title="Q-channel low-power interface"></a>Q-channel low-power interface</h2><blockquote>
<p>(Applicable to Cortex-M23, Cortex-M33,Cortex-M35P)</p>
</blockquote>
<p>部分较新的处理器（Cortex-M23, Cortex-M33,Cortex-M35P）支持Q channel，这是AMBA 4 低功耗接口中定义的握手协议；</p>
<p>略</p>
<h2 id="Sleep-hold-interface"><a href="#Sleep-hold-interface" class="headerlink" title="Sleep hold interface"></a>Sleep hold interface</h2><p><font color=blue>sleep hold interface的作用</font></p>
<p>当处理器从sleep mode唤醒的时候，可以使用这个接口延缓程序的执行；</p>
<p><font color=blue>sleep hold interface的使用场景</font></p>
<p>处理器的运行需要SRAM，但是SRAM可能需要一定的时间才能从低功耗状态退出，在SRAM退出低功耗状态时，CPU不应该执行程序，此时就可以使用这个端口；</p>
<p>当在deep sleep mode的时候，<code>如果采用WIC的方案，整个特性就很少会被使用</code>。因为当使用WIC的时候，此时的门控机制会关闭处理器的所有时钟，让其处于低功耗模式；</p>
<blockquote>
<p>思考：</p>
<p><font color=red>没太懂，为啥使用WIC方案的时候，sleep hold 这个特性很少会用到？</font></p>
</blockquote>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240721172648556.png" class="">

<blockquote>
<p>这两个信号都是低电平有效，一般和功耗管理单元PMU交互</p>
</blockquote>
<p><font color=blue>sleep hold interface的使用方式</font></p>
<p>1、当PMU检测到SLEEP&#x2F;DEEPSLEEP信号的时候，会assert SLEEPHOLDREQn；</p>
<p>2、处理器返回SLEEPHOLDACKn</p>
<ul>
<li>如果处理器 asset SLEEPHOLDACKn，此时PMU就可以关闭memory，外设，时钟等等；</li>
<li>如果处理器没有asset SLEEPHOLDACKn，此时意味着，处理器又接收到中断或者debugger request，直接就会被唤醒；在这种情况下，PMU就不应该进行下一步的行为，并且在SLEEPING or SLEEPDEEP  de-assert的时候，需要de-assert SLEEPHOLDACKn；</li>
</ul>
<p>3、如果处理器 asset SLEEPHOLDACKn，唤醒中断到来的时候，处理器将会de-asset sleep signal，此时处理器并不会立刻执行程序，而是需要等到SLEEPHOLDREQn  deassert</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240722163855336.png" class="">

<blockquote>
<p>思考：</p>
<p>1、<font color=red>SLEEPHOLDACKn  会在什么时候从core返回？？</font></p>
<p>2、在extended sleep  阶段，GATEHCLK有可能还是高电平，此时HCLK会被gating off；（特定于处理器，不同处理器的行为可能不相同）</p>
<p>3、目前接触的项目中，并没有使用这个特性；</p>
</blockquote>
<p><font color=blue>如果不需要这个sleep hold feature  ，需要将SLEEPHOLDREQn  &#x3D; 1‘b1;</font></p>
<h2 id="Wakeup-Interrupt-Controller-WIC"><a href="#Wakeup-Interrupt-Controller-WIC" class="headerlink" title="Wakeup Interrupt Controller (WIC)"></a>Wakeup Interrupt Controller (WIC)</h2><p><font color=blue>为什么需要WIC</font></p>
<p>如果将CORE的所有时钟都关闭，或者CORE处于掉电状态（最大程度的降低CORE的功耗），那么NVIC此时就不能检测唤醒事件，此时就需要WIC。</p>
<h3 id="WIC接口"><a href="#WIC接口" class="headerlink" title="WIC接口"></a>WIC接口</h3><p>WIC是一个可选的模块，处于always-on power domain。当NVIC没有时钟或者掉电的时候，WIC起到检测中断事件的作用。</p>
<p>WIC接口特定于处理器，但是一般来说，：</p>
<ul>
<li>WIC和处理器的接口如下：</li>
</ul>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240722165602006.png" class="">

<ul>
<li>WIC和系统的接口如下：</li>
</ul>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240723104002065.png" class="">

<h3 id="WIC-demo-代码"><a href="#WIC-demo-代码" class="headerlink" title="WIC demo 代码"></a>WIC demo 代码</h3><p><font color=blue>Cortex-M产品包交付的WIC是一个示例逻辑，允许修改（如下面代码所示）。在某些情况下，designer会将WIC设计成基于锁存器的操作，这样的话，唤醒时间的检测和capture就无需任何时钟;</font></p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// The confidential and proprietary information contained in this file may</span></span><br><span class="line"><span class="comment">// only be used by a person authorised under and to the extent permitted</span></span><br><span class="line"><span class="comment">// by a subsisting licensing agreement from ARM Limited.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            (C) COPYRIGHT 2004-2010 ARM Limited.</span></span><br><span class="line"><span class="comment">//                ALL RIGHTS RESERVED</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This entire notice must be reproduced on all copies of this file</span></span><br><span class="line"><span class="comment">// and copies of this file may only be made by a person if such person is</span></span><br><span class="line"><span class="comment">// permitted to do so under the terms of a subsisting license agreement</span></span><br><span class="line"><span class="comment">// from ARM Limited.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Revision            : $Revision: 141802 $</span></span><br><span class="line"><span class="comment">//  Release information : cortexm4_r0p1_00rel0</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Purpose: Wake-Up Interrupt Controller (WIC)</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> cm4_wic</span><br><span class="line">  (<span class="comment">// Inputs</span></span><br><span class="line">   FCLK, RESETn, WICLOAD, WICCLEAR, WICINT, WICMASK, WICENREQ,</span><br><span class="line">   WICDSACKn,</span><br><span class="line">   <span class="comment">// Outputs</span></span><br><span class="line">   WAKEUP, WICSENSE, WICPEND, WICDSREQn, WICENACK</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Parameters</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">parameter</span> WIC_PRESENT = <span class="number">0</span>;  <span class="comment">// WIC present if 1.</span></span><br><span class="line">  <span class="keyword">parameter</span> WIC_LINES   = <span class="number">8</span>;  <span class="comment">// Number of WIC lines. Min value is 3.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Port declarations</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clocks and resets</span></span><br><span class="line">  <span class="keyword">input</span>                  FCLK;</span><br><span class="line">  <span class="keyword">input</span>                  RESETn;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// WIC interface</span></span><br><span class="line">  <span class="keyword">input</span>                  WICLOAD;     <span class="comment">// WIC mask load from core</span></span><br><span class="line">  <span class="keyword">input</span>                  WICCLEAR;    <span class="comment">// WIC mask clear from core</span></span><br><span class="line">  <span class="keyword">input</span>  [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] WICINT;      <span class="comment">// Interrupt request from system</span></span><br><span class="line">  <span class="keyword">input</span>  [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] WICMASK;     <span class="comment">// Mask from core</span></span><br><span class="line">  <span class="keyword">input</span>                  WICENREQ;    <span class="comment">// WIC enable request from PMU</span></span><br><span class="line">  <span class="keyword">input</span>                  WICDSACKn;   <span class="comment">// WIC enable ack from core</span></span><br><span class="line">  <span class="keyword">output</span> [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] WICSENSE;    <span class="comment">// Input lines that can generate WAKEUP</span></span><br><span class="line">  <span class="keyword">output</span> [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] WICPEND;     <span class="comment">// Pended interrupt request</span></span><br><span class="line">  <span class="keyword">output</span>                 WICDSREQn;   <span class="comment">// WIC enable request to core</span></span><br><span class="line">  <span class="keyword">output</span>                 WICENACK;    <span class="comment">// WIC enable ack to PMU</span></span><br><span class="line">  <span class="keyword">output</span>                 WAKEUP;      <span class="comment">// Wake up request to PMU</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Signal declarations</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Pending and status registers</span></span><br><span class="line">  <span class="keyword">reg</span>    [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] wic_sense;        <span class="comment">// Interrupt mask register</span></span><br><span class="line">  <span class="keyword">wire</span>   [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] nxt_wic_sense;</span><br><span class="line">  <span class="keyword">wire</span>                   wic_sense_we;</span><br><span class="line">  <span class="keyword">reg</span>    [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] wic_pend;         <span class="comment">// Interrupt pend register</span></span><br><span class="line">  <span class="keyword">wire</span>   [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] nxt_wic_pend;</span><br><span class="line">  <span class="keyword">wire</span>                   wic_pend_we;</span><br><span class="line">  <span class="keyword">reg</span>                    wic_active;       <span class="comment">// Active status register</span></span><br><span class="line">  <span class="keyword">wire</span>                   wic_active_we;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// WIC enable handshake signals</span></span><br><span class="line">  <span class="keyword">reg</span>                    wic_ds_req;</span><br><span class="line">  <span class="keyword">wire</span>                   set_wic_ds_req;</span><br><span class="line">  <span class="keyword">wire</span>                   clr_wic_ds_req;</span><br><span class="line">  <span class="keyword">wire</span>                   wic_ds_req_we;</span><br><span class="line">  <span class="keyword">reg</span>                    wic_en_ack;</span><br><span class="line">  <span class="keyword">wire</span>                   set_wic_en_ack;</span><br><span class="line">  <span class="keyword">wire</span>                   clr_wic_en_ack;</span><br><span class="line">  <span class="keyword">wire</span>                   wic_en_ack_we;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PMU wakeup</span></span><br><span class="line">  <span class="keyword">wire</span>                   wakeup_pmu;       <span class="comment">// Request wakeup to PMU</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Logic removal terms</span></span><br><span class="line">  <span class="keyword">wire</span>                   opt_mst_wic_en;</span><br><span class="line">  <span class="keyword">wire</span>                   opt_wakeup;</span><br><span class="line">  <span class="keyword">wire</span>   [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] opt_wic_sense;</span><br><span class="line">  <span class="keyword">wire</span>   [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] opt_wic_pend;</span><br><span class="line">  <span class="keyword">wire</span>                   opt_wic_ds_req_n;</span><br><span class="line">  <span class="keyword">wire</span>                   opt_wic_en_ack;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Logic removal</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">assign</span> opt_wakeup       = (WIC_PRESENT != <span class="number">0</span>) ? wakeup_pmu  : <span class="number">1&#x27;b0</span>;</span><br><span class="line">  <span class="keyword">assign</span> opt_wic_sense    = (WIC_PRESENT != <span class="number">0</span>) ? wic_sense   : &#123;WIC_LINES&#123;<span class="number">1&#x27;b0</span>&#125;&#125;;</span><br><span class="line">  <span class="keyword">assign</span> opt_wic_pend     = (WIC_PRESENT != <span class="number">0</span>) ? wic_pend    : &#123;WIC_LINES&#123;<span class="number">1&#x27;b0</span>&#125;&#125;;</span><br><span class="line">  <span class="keyword">assign</span> opt_wic_ds_req_n = (WIC_PRESENT != <span class="number">0</span>) ? ~wic_ds_req : <span class="number">1&#x27;b1</span>;</span><br><span class="line">  <span class="keyword">assign</span> opt_wic_en_ack   = (WIC_PRESENT != <span class="number">0</span>) ? wic_en_ack  : <span class="number">1&#x27;b0</span>;</span><br><span class="line">  <span class="keyword">assign</span> opt_mst_wic_en   = (WIC_PRESENT != <span class="number">0</span>) ? <span class="number">1&#x27;b1</span>        : <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// WIC enable handshake</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Request WIC mode sleep if PMU request is asserted and debugger is not</span></span><br><span class="line">  <span class="comment">// connected</span></span><br><span class="line">  <span class="keyword">assign</span> set_wic_ds_req = WICENREQ &amp; opt_wic_ds_req_n;</span><br><span class="line">  <span class="keyword">assign</span> clr_wic_ds_req = ~opt_wic_ds_req_n &amp; ~WICENREQ;</span><br><span class="line">  <span class="keyword">assign</span> wic_ds_req_we  = opt_mst_wic_en &amp; (set_wic_ds_req | clr_wic_ds_req);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always</span> @ (<span class="keyword">posedge</span> FCLK <span class="keyword">or</span> <span class="keyword">negedge</span> RESETn)</span><br><span class="line">    <span class="keyword">if</span> (!RESETn)</span><br><span class="line">      wic_ds_req &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wic_ds_req_we)</span><br><span class="line">      wic_ds_req &lt;= set_wic_ds_req;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Acknowledge PMU request if core accepts and the debugger is not connected</span></span><br><span class="line">  <span class="keyword">assign</span> set_wic_en_ack = ~WICDSACKn &amp; ~opt_wic_en_ack;</span><br><span class="line">  <span class="keyword">assign</span> clr_wic_en_ack = opt_wic_en_ack &amp; WICDSACKn;</span><br><span class="line">  <span class="keyword">assign</span> wic_en_ack_we  = opt_mst_wic_en &amp; (set_wic_en_ack | clr_wic_en_ack);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always</span> @ (<span class="keyword">posedge</span> FCLK <span class="keyword">or</span> <span class="keyword">negedge</span> RESETn)</span><br><span class="line">    <span class="keyword">if</span> (!RESETn)</span><br><span class="line">      wic_en_ack &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wic_en_ack_we)</span><br><span class="line">      wic_en_ack &lt;= set_wic_en_ack;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// LOAD/CLEAR WIC sensitivity</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set mask value depending on operation</span></span><br><span class="line">  <span class="keyword">assign</span> nxt_wic_sense = &#123;WIC_LINES&#123;WICLOAD&#125;&#125; &amp; WICMASK;</span><br><span class="line">  <span class="keyword">assign</span> wic_sense_we  = opt_mst_wic_en &amp; (WICCLEAR | WICLOAD);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always</span> @ (<span class="keyword">posedge</span> FCLK <span class="keyword">or</span> <span class="keyword">negedge</span> RESETn)</span><br><span class="line">    <span class="keyword">if</span> (!RESETn)</span><br><span class="line">      wic_sense &lt;= &#123;WIC_LINES&#123;<span class="number">1&#x27;b0</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wic_sense_we)</span><br><span class="line">      wic_sense &lt;= nxt_wic_sense;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Pend interrupts</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">assign</span> nxt_wic_pend = &#123;WIC_LINES&#123;~WICCLEAR&#125;&#125; &amp; (WICINT | wic_pend);</span><br><span class="line">  <span class="keyword">assign</span> wic_pend_we  = opt_mst_wic_en &amp; (WICLOAD | wic_active) &amp; (WICCLEAR | (|WICINT));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always</span> @( <span class="keyword">posedge</span> FCLK <span class="keyword">or</span> <span class="keyword">negedge</span> RESETn)</span><br><span class="line">    <span class="keyword">if</span> (!RESETn)</span><br><span class="line">      wic_pend &lt;= &#123;WIC_LINES&#123;<span class="number">1&#x27;b0</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wic_pend_we)</span><br><span class="line">      wic_pend &lt;= nxt_wic_pend;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Active status register</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">assign</span> wic_active_we = opt_mst_wic_en &amp; (WICLOAD | WICCLEAR);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always</span> @ (<span class="keyword">posedge</span> FCLK <span class="keyword">or</span> <span class="keyword">negedge</span> RESETn)</span><br><span class="line">    <span class="keyword">if</span> (!RESETn)</span><br><span class="line">      wic_active &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wic_active_we)</span><br><span class="line">      wic_active &lt;= WICLOAD;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Request wake-up</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wake up if something has been pended that is observed whilst powered down</span></span><br><span class="line">  <span class="keyword">assign</span> wakeup_pmu = (|(wic_pend &amp; wic_sense));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Output assignments</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">assign</span> WAKEUP    = opt_wakeup;</span><br><span class="line">  <span class="keyword">assign</span> WICSENSE  = opt_wic_sense;</span><br><span class="line">  <span class="keyword">assign</span> WICPEND   = opt_wic_pend;</span><br><span class="line">  <span class="keyword">assign</span> WICDSREQn = opt_wic_ds_req_n;</span><br><span class="line">  <span class="keyword">assign</span> WICENACK  = opt_wic_en_ack;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// OVL assertions</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">ifdef</span> ARM_ASSERT_ON</span></span><br><span class="line">  assert_never_unknown <span class="variable">#(0,1,0, &quot;wic_ds_req_we must not be unknown&quot;)</span></span><br><span class="line">  ts_wic_ds_req_we_unknown</span><br><span class="line">    (<span class="variable">.clk</span>       (FCLK),</span><br><span class="line">     <span class="variable">.reset_n</span>   (RESETn),</span><br><span class="line">     <span class="variable">.qualifier</span> (<span class="number">1&#x27;b1</span>),</span><br><span class="line">     <span class="variable">.test_expr</span> (wic_ds_req_we));</span><br><span class="line"></span><br><span class="line">  assert_never_unknown <span class="variable">#(0,1,0, &quot;wic_sense_we must not be unknown&quot;)</span></span><br><span class="line">  ts_wic_sense_we_unknown</span><br><span class="line">    (<span class="variable">.clk</span>       (FCLK),</span><br><span class="line">     <span class="variable">.reset_n</span>   (RESETn),</span><br><span class="line">     <span class="variable">.qualifier</span> (<span class="number">1&#x27;b1</span>),</span><br><span class="line">     <span class="variable">.test_expr</span> (wic_sense_we));</span><br><span class="line"></span><br><span class="line">  assert_never_unknown <span class="variable">#(0,1,0, &quot;wic_pend_we must not be unknown&quot;)</span></span><br><span class="line">  ts_wic_pend_we_unknown</span><br><span class="line">    (<span class="variable">.clk</span>       (FCLK),</span><br><span class="line">     <span class="variable">.reset_n</span>   (RESETn),</span><br><span class="line">     <span class="variable">.qualifier</span> (<span class="number">1&#x27;b1</span>),</span><br><span class="line">     <span class="variable">.test_expr</span> (wic_pend_we));</span><br><span class="line"></span><br><span class="line">  assert_never_unknown <span class="variable">#(0,1,0, &quot;wic_active_we must not be unknown&quot;)</span></span><br><span class="line">  ts_wic_active_we_unknown</span><br><span class="line">    (<span class="variable">.clk</span>       (FCLK),</span><br><span class="line">     <span class="variable">.reset_n</span>   (RESETn),</span><br><span class="line">     <span class="variable">.qualifier</span> (<span class="number">1&#x27;b1</span>),</span><br><span class="line">     <span class="variable">.test_expr</span> (wic_active_we));</span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">endmodule</span></span><br></pre></td></tr></table></figure>

<h3 id="WIC修改后基于锁存的代码"><a href="#WIC修改后基于锁存的代码" class="headerlink" title="WIC修改后基于锁存的代码"></a>WIC修改后基于锁存的代码</h3><p>项目中的修改：</p>
<figure class="highlight verilog"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// The confidential and proprietary information contained in this file may</span></span><br><span class="line"><span class="comment">// only be used by a person authorised under and to the extent permitted</span></span><br><span class="line"><span class="comment">// by a subsisting licensing agreement from ARM Limited.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//            (C) COPYRIGHT 2004-2010 ARM Limited.</span></span><br><span class="line"><span class="comment">//                ALL RIGHTS RESERVED</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// This entire notice must be reproduced on all copies of this file</span></span><br><span class="line"><span class="comment">// and copies of this file may only be made by a person if such person is</span></span><br><span class="line"><span class="comment">// permitted to do so under the terms of a subsisting license agreement</span></span><br><span class="line"><span class="comment">// from ARM Limited.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//  Revision            : $Revision: 141802 $</span></span><br><span class="line"><span class="comment">//  Release information : cortexm4_r0p1_00rel0</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">// Purpose: Wake-Up Interrupt Controller (WIC)</span></span><br><span class="line"><span class="comment">//------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">module</span> cm4_wic</span><br><span class="line">  (<span class="comment">// Inputs</span></span><br><span class="line">   TESTMODE, SCANCLK, FCLK, RESETn, WICLOAD, WICCLEAR, WICINT, WICMASK, WICENREQ,</span><br><span class="line">   WICDSACKn,</span><br><span class="line">   <span class="comment">// Outputs</span></span><br><span class="line">   WAKEUP, WICSENSE, WICPEND, WICDSREQn, WICENACK</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Parameters</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">parameter</span> WIC_PRESENT = <span class="number">0</span>;  <span class="comment">// WIC present if 1.</span></span><br><span class="line">  <span class="keyword">parameter</span> WIC_LINES   = <span class="number">8</span>;  <span class="comment">// Number of WIC lines. Min value is 3.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Port declarations</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">input</span>                  TESTMODE;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Clocks and resets</span></span><br><span class="line">  <span class="keyword">input</span>                  SCANCLK;</span><br><span class="line">  <span class="keyword">input</span>                  FCLK;</span><br><span class="line">  <span class="keyword">input</span>                  RESETn;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// WIC interface</span></span><br><span class="line">  <span class="keyword">input</span>                  WICLOAD;     <span class="comment">// WIC mask load from core</span></span><br><span class="line">  <span class="keyword">input</span>                  WICCLEAR;    <span class="comment">// WIC mask clear from core</span></span><br><span class="line">  <span class="keyword">input</span>  [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] WICINT;      <span class="comment">// Interrupt request from system</span></span><br><span class="line">  <span class="keyword">input</span>  [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] WICMASK;     <span class="comment">// Mask from core</span></span><br><span class="line">  <span class="keyword">input</span>                  WICENREQ;    <span class="comment">// WIC enable request from PMU</span></span><br><span class="line">  <span class="keyword">input</span>                  WICDSACKn;   <span class="comment">// WIC enable ack from core</span></span><br><span class="line">  <span class="keyword">output</span> [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] WICSENSE;    <span class="comment">// Input lines that can generate WAKEUP</span></span><br><span class="line">  <span class="keyword">output</span> [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] WICPEND;     <span class="comment">// Pended interrupt request</span></span><br><span class="line">  <span class="keyword">output</span>                 WICDSREQn;   <span class="comment">// WIC enable request to core</span></span><br><span class="line">  <span class="keyword">output</span>                 WICENACK;    <span class="comment">// WIC enable ack to PMU</span></span><br><span class="line">  <span class="keyword">output</span>                 WAKEUP;      <span class="comment">// Wake up request to PMU</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Signal declarations</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Pending and status registers</span></span><br><span class="line">  <span class="keyword">reg</span>    [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] wic_sense;        <span class="comment">// Interrupt mask register</span></span><br><span class="line">  <span class="keyword">wire</span>   [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] nxt_wic_sense;</span><br><span class="line">  <span class="keyword">wire</span>                   wic_sense_we;</span><br><span class="line">  <span class="keyword">reg</span>    [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] wic_pend;         <span class="comment">// Interrupt pend register</span></span><br><span class="line">  <span class="keyword">wire</span>   [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] nxt_wic_pend;</span><br><span class="line">  <span class="keyword">wire</span>                   wic_pend_we;</span><br><span class="line">  <span class="keyword">reg</span>                    wic_active;       <span class="comment">// Active status register</span></span><br><span class="line">  <span class="keyword">wire</span>                   wic_active_we;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// WIC enable handshake signals</span></span><br><span class="line">  <span class="keyword">reg</span>                    wic_ds_req;</span><br><span class="line">  <span class="keyword">wire</span>                   set_wic_ds_req;</span><br><span class="line">  <span class="keyword">wire</span>                   clr_wic_ds_req;</span><br><span class="line">  <span class="keyword">wire</span>                   wic_ds_req_we;</span><br><span class="line">  <span class="keyword">reg</span>                    wic_en_ack;</span><br><span class="line">  <span class="keyword">wire</span>                   set_wic_en_ack;</span><br><span class="line">  <span class="keyword">wire</span>                   clr_wic_en_ack;</span><br><span class="line">  <span class="keyword">wire</span>                   wic_en_ack_we;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PMU wakeup</span></span><br><span class="line">  <span class="keyword">wire</span>                   wakeup_pmu;       <span class="comment">// Request wakeup to PMU</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Logic removal terms</span></span><br><span class="line">  <span class="keyword">wire</span>                   opt_mst_wic_en;</span><br><span class="line">  <span class="keyword">wire</span>                   opt_wakeup;</span><br><span class="line">  <span class="keyword">wire</span>   [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] opt_wic_sense;</span><br><span class="line">  <span class="keyword">wire</span>   [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] opt_wic_pend;</span><br><span class="line">  <span class="keyword">wire</span>                   opt_wic_ds_req_n;</span><br><span class="line">  <span class="keyword">wire</span>                   opt_wic_en_ack;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Logic removal</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">assign</span> opt_wakeup       = (WIC_PRESENT != <span class="number">0</span>) ? wakeup_pmu  : <span class="number">1&#x27;b0</span>;</span><br><span class="line">  <span class="keyword">assign</span> opt_wic_sense    = (WIC_PRESENT != <span class="number">0</span>) ? wic_sense   : &#123;WIC_LINES&#123;<span class="number">1&#x27;b0</span>&#125;&#125;;</span><br><span class="line">  <span class="keyword">assign</span> opt_wic_pend     = (WIC_PRESENT != <span class="number">0</span>) ? wic_pend    : &#123;WIC_LINES&#123;<span class="number">1&#x27;b0</span>&#125;&#125;;</span><br><span class="line">  <span class="keyword">assign</span> opt_wic_ds_req_n = (WIC_PRESENT != <span class="number">0</span>) ? ~wic_ds_req : <span class="number">1&#x27;b1</span>;</span><br><span class="line">  <span class="keyword">assign</span> opt_wic_en_ack   = (WIC_PRESENT != <span class="number">0</span>) ? wic_en_ack  : <span class="number">1&#x27;b0</span>;</span><br><span class="line">  <span class="keyword">assign</span> opt_mst_wic_en   = (WIC_PRESENT != <span class="number">0</span>) ? <span class="number">1&#x27;b1</span>        : <span class="number">1&#x27;b0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// WIC enable handshake</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Request WIC mode sleep if PMU request is asserted and debugger is not</span></span><br><span class="line">  <span class="comment">// connected</span></span><br><span class="line">  <span class="keyword">assign</span> set_wic_ds_req = WICENREQ &amp; opt_wic_ds_req_n;</span><br><span class="line">  <span class="keyword">assign</span> clr_wic_ds_req = ~opt_wic_ds_req_n &amp; ~WICENREQ;</span><br><span class="line">  <span class="keyword">assign</span> wic_ds_req_we  = opt_mst_wic_en &amp; (set_wic_ds_req | clr_wic_ds_req);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always</span> @ (<span class="keyword">posedge</span> FCLK <span class="keyword">or</span> <span class="keyword">negedge</span> RESETn)</span><br><span class="line">    <span class="keyword">if</span> (!RESETn)</span><br><span class="line">      wic_ds_req &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wic_ds_req_we)</span><br><span class="line">      wic_ds_req &lt;= set_wic_ds_req;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Acknowledge PMU request if core accepts and the debugger is not connected</span></span><br><span class="line">  <span class="keyword">assign</span> set_wic_en_ack = ~WICDSACKn &amp; ~opt_wic_en_ack;</span><br><span class="line">  <span class="keyword">assign</span> clr_wic_en_ack = opt_wic_en_ack &amp; WICDSACKn;</span><br><span class="line">  <span class="keyword">assign</span> wic_en_ack_we  = opt_mst_wic_en &amp; (set_wic_en_ack | clr_wic_en_ack);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always</span> @ (<span class="keyword">posedge</span> FCLK <span class="keyword">or</span> <span class="keyword">negedge</span> RESETn)</span><br><span class="line">    <span class="keyword">if</span> (!RESETn)</span><br><span class="line">      wic_en_ack &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wic_en_ack_we)</span><br><span class="line">      wic_en_ack &lt;= set_wic_en_ack;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// LOAD/CLEAR WIC sensitivity</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set mask value depending on operation</span></span><br><span class="line">  <span class="keyword">assign</span> nxt_wic_sense = &#123;WIC_LINES&#123;WICLOAD&#125;&#125; &amp; WICMASK;</span><br><span class="line">  <span class="keyword">assign</span> wic_sense_we  = opt_mst_wic_en &amp; (WICCLEAR | WICLOAD);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always</span> @ (<span class="keyword">posedge</span> FCLK <span class="keyword">or</span> <span class="keyword">negedge</span> RESETn)</span><br><span class="line">    <span class="keyword">if</span> (!RESETn)</span><br><span class="line">      wic_sense &lt;= &#123;WIC_LINES&#123;<span class="number">1&#x27;b0</span>&#125;&#125;;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wic_sense_we)</span><br><span class="line">      wic_sense &lt;= nxt_wic_sense;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Pend interrupts</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">assign</span> nxt_wic_pend = &#123;WIC_LINES&#123;~WICCLEAR&#125;&#125; &amp; (WICINT | wic_pend);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//AWIC modify by zhbin 20200826</span></span><br><span class="line">  <span class="comment">//assign wic_pend_we  = opt_mst_wic_en &amp; (WICLOAD | wic_active) &amp; (WICCLEAR | (|WICINT));</span></span><br><span class="line">  <span class="comment">//always @(posedge FCLK or negedge RESETn)</span></span><br><span class="line">  <span class="comment">//  if (!RESETn)</span></span><br><span class="line">  <span class="comment">//    wic_pend &lt;= &#123;WIC_LINES&#123;1&#x27;b0&#125;&#125;;</span></span><br><span class="line">  <span class="comment">//  else if (wic_pend_we)</span></span><br><span class="line">  <span class="comment">//    wic_pend &lt;= nxt_wic_pend;</span></span><br><span class="line">  <span class="keyword">wire</span>  wicclear_tmp;</span><br><span class="line">  dtc_buf  dtc_dly_wicclr_tmp( <span class="variable">.I</span>( !WICCLEAR ), <span class="variable">.Z</span>( wicclear_tmp ) );</span><br><span class="line">  <span class="comment">//assign wic_pend_we  = opt_mst_wic_en &amp; (WICLOAD | wic_active) &amp; (|WICINT);</span></span><br><span class="line">  <span class="keyword">assign</span> wic_pend_we  = opt_mst_wic_en &amp; (WICLOAD | wic_active) ; <span class="comment">//20210731 atc1010 update</span></span><br><span class="line">  <span class="comment">//wire wic_pend_clr_n = RESETn &amp; !WICCLEAR;</span></span><br><span class="line">  <span class="keyword">wire</span> wic_pend_clr_n = RESETn &amp; wicclear_tmp; <span class="comment">//20220629 atc1010 just add dtc buf;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="keyword">wire</span>  [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] wic_pend_clk;</span><br><span class="line">  <span class="keyword">wire</span>  [WIC_LINES-<span class="number">1</span>:<span class="number">0</span>] wic_pend_clk_mux;</span><br><span class="line">  <span class="keyword">wire</span>                  wic_pend_clr_n_mux;</span><br><span class="line">  dtc_ckmux2 dtc_wic_pend_rst (<span class="variable">.S</span>(TESTMODE), <span class="variable">.I0</span>(wic_pend_clr_n), <span class="variable">.I1</span>(RESETn), <span class="variable">.Z</span>(wic_pend_clr_n_mux));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">genvar</span> i;</span><br><span class="line">  <span class="keyword">generate</span></span><br><span class="line">     <span class="keyword">for</span>(i=<span class="number">0</span>;i&lt;WIC_LINES;i=i+<span class="number">1</span>)</span><br><span class="line">     <span class="keyword">begin</span>:wic_pend_int</span><br><span class="line"></span><br><span class="line">       dtc_ckbuf  dtc_ckbuf_int( <span class="variable">.I</span>(wic_active &amp; nxt_wic_pend[i]), <span class="variable">.Z</span>(wic_pend_clk[i]) );</span><br><span class="line">       dtc_ckmux2 dtc_wic_pend_mux (<span class="variable">.S</span>(TESTMODE), <span class="variable">.I0</span>(wic_pend_clk[i]), <span class="variable">.I1</span>(SCANCLK), <span class="variable">.Z</span>(wic_pend_clk_mux[i]));</span><br><span class="line">       <span class="keyword">always</span> @(<span class="keyword">posedge</span> wic_pend_clk_mux[i] <span class="keyword">or</span> <span class="keyword">negedge</span> wic_pend_clr_n_mux)</span><br><span class="line">       <span class="keyword">if</span> (!wic_pend_clr_n_mux)</span><br><span class="line">       <span class="comment">//wic_pend[i] &lt;= &#123;WIC_LINES&#123;1&#x27;b0&#125;&#125;;</span></span><br><span class="line">         wic_pend[i] &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (wic_pend_we)</span><br><span class="line">       <span class="comment">//wic_pend[i] &lt;= nxt_wic_pend[i];       </span></span><br><span class="line">         wic_pend[i] &lt;= <span class="number">1&#x27;b1</span>;</span><br><span class="line">     <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">endgenerate</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Active status register</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">assign</span> wic_active_we = opt_mst_wic_en &amp; (WICLOAD | WICCLEAR);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">always</span> @ (<span class="keyword">posedge</span> FCLK <span class="keyword">or</span> <span class="keyword">negedge</span> RESETn)</span><br><span class="line">    <span class="keyword">if</span> (!RESETn)</span><br><span class="line">      wic_active &lt;= <span class="number">1&#x27;b0</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (wic_active_we)</span><br><span class="line">      wic_active &lt;= WICLOAD;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Request wake-up</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wake up if something has been pended that is observed whilst powered down</span></span><br><span class="line">  <span class="keyword">assign</span> wakeup_pmu = (|(wic_pend &amp; wic_sense));</span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// Output assignments</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="keyword">assign</span> WAKEUP    = opt_wakeup;</span><br><span class="line">  <span class="keyword">assign</span> WICSENSE  = opt_wic_sense;</span><br><span class="line">  <span class="keyword">assign</span> WICPEND   = opt_wic_pend;</span><br><span class="line">  <span class="keyword">assign</span> WICDSREQn = opt_wic_ds_req_n;</span><br><span class="line">  <span class="keyword">assign</span> WICENACK  = opt_wic_en_ack;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line">  <span class="comment">// OVL assertions</span></span><br><span class="line">  <span class="comment">//----------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">ifdef</span> ARM_ASSERT_ON</span></span><br><span class="line">  assert_never_unknown <span class="variable">#(0,1,0, &quot;wic_ds_req_we must not be unknown&quot;)</span></span><br><span class="line">  ts_wic_ds_req_we_unknown</span><br><span class="line">    (<span class="variable">.clk</span>       (FCLK),</span><br><span class="line">     <span class="variable">.reset_n</span>   (RESETn),</span><br><span class="line">     <span class="variable">.qualifier</span> (<span class="number">1&#x27;b1</span>),</span><br><span class="line">     <span class="variable">.test_expr</span> (wic_ds_req_we));</span><br><span class="line"></span><br><span class="line">  assert_never_unknown <span class="variable">#(0,1,0, &quot;wic_sense_we must not be unknown&quot;)</span></span><br><span class="line">  ts_wic_sense_we_unknown</span><br><span class="line">    (<span class="variable">.clk</span>       (FCLK),</span><br><span class="line">     <span class="variable">.reset_n</span>   (RESETn),</span><br><span class="line">     <span class="variable">.qualifier</span> (<span class="number">1&#x27;b1</span>),</span><br><span class="line">     <span class="variable">.test_expr</span> (wic_sense_we));</span><br><span class="line"></span><br><span class="line">  assert_never_unknown <span class="variable">#(0,1,0, &quot;wic_pend_we must not be unknown&quot;)</span></span><br><span class="line">  ts_wic_pend_we_unknown</span><br><span class="line">    (<span class="variable">.clk</span>       (FCLK),</span><br><span class="line">     <span class="variable">.reset_n</span>   (RESETn),</span><br><span class="line">     <span class="variable">.qualifier</span> (<span class="number">1&#x27;b1</span>),</span><br><span class="line">     <span class="variable">.test_expr</span> (wic_pend_we));</span><br><span class="line"></span><br><span class="line">  assert_never_unknown <span class="variable">#(0,1,0, &quot;wic_active_we must not be unknown&quot;)</span></span><br><span class="line">  ts_wic_active_we_unknown</span><br><span class="line">    (<span class="variable">.clk</span>       (FCLK),</span><br><span class="line">     <span class="variable">.reset_n</span>   (RESETn),</span><br><span class="line">     <span class="variable">.qualifier</span> (<span class="number">1&#x27;b1</span>),</span><br><span class="line">     <span class="variable">.test_expr</span> (wic_active_we));</span><br><span class="line"></span><br><span class="line"><span class="meta">`<span class="keyword">endif</span></span></span><br><span class="line"><span class="keyword">endmodule</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240723104805892.png" class="">

<blockquote>
<p>项目中是如上图这么做的</p>
<p><font color=red>有个问题，clock后面需要弄一个clock mux，用于切换scan和function clock？为什么这么做？</font></p>
</blockquote>
<h3 id="WIC的工作流程"><a href="#WIC的工作流程" class="headerlink" title="WIC的工作流程"></a>WIC的工作流程</h3><p>1、当进入睡眠模式的时候，wakeup event mask将会从NVIC–》WIC，通过(WICMASK[] and WICLOAD)。</p>
<p>2、当唤醒事件到来的时候，WIC将会发送wake up request到PMU</p>
<p>3、PMU控制处理器的power和clock恢复；此时处理器可以接收中断请求（或其他唤醒事件）；</p>
<p>4、当处理器被唤醒之后，WIC的wake-up mask信息以及pending wake-up event将会被自动清除(WICCLEAR)  </p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240723111728699.png" class="">

<h3 id="WIC的详细时序图"><a href="#WIC的详细时序图" class="headerlink" title="WIC的详细时序图"></a>WIC的详细时序图</h3><img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240730094308493.png" class="">



<h3 id="WIC的集成"><a href="#WIC的集成" class="headerlink" title="WIC的集成"></a>WIC的集成</h3><p>Cortex-M处理器，部分是将WIC放在处理器内部，有些是将WIC放在处理器外部；</p>
<p>放在外部的WIC，集成上略有不同：</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240723111937842.png" class="">



<h3 id="EDBGRQ信号"><a href="#EDBGRQ信号" class="headerlink" title="EDBGRQ信号"></a>EDBGRQ信号</h3><p>Armv7-M 和 Armv8-M Mainline 处理器系统中，会将EDBGRQ signal (external debug request)  作为WIC的唤醒源之一，因为外部debug请求会触发Debug Monitor exception；</p>
<p>但是在Armv6-M 和 Armv8-M baseline 系统（如 Cortex-M23 处理器系统）中，因为没有Debug Monitor exception，因此就没有外部debug请求；</p>
<blockquote>
<p>思考：</p>
<p>1、什么是Mainline？什么是baseline？</p>
<p>在Arm架构中，术语“Mainline”和“baseline”通常用来区分不同的处理器配置或特性水平。这些术语可以根据具体的处理器系列和架构版本来理解：</p>
<ol>
<li>Mainline：<ul>
<li>在Arm架构中，“Mainline”通常指的是支持全套标准特性和功能的处理器配置。这些处理器通常具有较高的性能和更广泛的功能集，能够满足多种应用需求。例如，在Cortex-M系列中，Mainline处理器通常支持较多的调试和安全功能，如调试监视器异常和硬件安全扩展。</li>
</ul>
</li>
<li>Baseline：<ul>
<li>相比之下，“Baseline”处理器配置则是指针对低成本、低功耗以及对特定应用需求的优化。这些处理器可能会限制一些高级特性或功能，以降低成本和功耗，同时仍提供足够的性能来处理典型的嵌入式应用。在Arm的术语中，Baseline配置可能会限制或不支持一些高级的调试功能或安全扩展。</li>
</ul>
</li>
</ol>
<p><font color=red>2、debug monitor异常？</font></p>
</blockquote>
<h3 id="WIC可以通过handshake信号enable或者disable"><a href="#WIC可以通过handshake信号enable或者disable" class="headerlink" title="WIC可以通过handshake信号enable或者disable"></a>WIC可以通过handshake信号enable或者disable</h3><p>在M3和M4系统中，其handshake信号有两对：</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240724150409817.png" class="">

<p>在程序开始的时候，软件去写PMU模块，让其和WIC进行handshake，使能WIC；这也使能了PMU去处理state retention  power gating；</p>
<p>WIC的enable 顺序如下：</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240724151628321.png" class="">

<blockquote>
<p>思考：</p>
<p><font color=red>PMU什么时候去处理power gating？怎么去处理？</font></p>
</blockquote>
<h3 id="SRPG-support端口"><a href="#SRPG-support端口" class="headerlink" title="SRPG support端口"></a>SRPG support端口</h3><p>如果使用SRPG（State Retention Power Gating  ），需要去控制一系列的信号，并且需要看特定的工艺（cell的控制端口），但是通常来说，需要有如下信号：</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240724152606630.png" class="">

<h3 id="Demo-PMU-state-machine"><a href="#Demo-PMU-state-machine" class="headerlink" title="Demo PMU state machine"></a>Demo PMU state machine</h3><p>系统设计者需要通过state machine去控制power-down和power-up的状态，并且需要一个表示是否上电完成的信号PWRUPREADY（模拟LDO给数字供电需要一个过程），大概的流程如下所示：</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240724153806629.png" class="">

<blockquote>
<p>假设当前处于POWER-DOWN的状态：</p>
<p>1、当WIC检测到唤醒事件的时候，会有WAKEUP信号送到PMU；</p>
<p>2、PMU不在对状态保持逻辑做power gating，并且等到上电完成PWRUPREADY；</p>
<p>3、恢复状态保持寄存器的值；</p>
<p>4、关闭ISO单元；</p>
<p>5、打开时钟，关闭睡眠保持请求；</p>
<p>6、上电完成；</p>
</blockquote>
<p>还可以进一步设计，允许power down顺序被中断，从而减少中断响应的时间：</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240724154409712.png" class="">



<blockquote>
<p><font color=red>启用WIC的软件流程是什么？</font></p>
</blockquote>
<h2 id="SRPG’s-impact-on-software"><a href="#SRPG’s-impact-on-software" class="headerlink" title="SRPG’s impact on software"></a>SRPG’s impact on software</h2><p>SRPG对软件有一定的影响，需要考虑如下方面：</p>
<p>1、systick timer将会被关闭。此时如果还需要定时操作的话，需要使用外部时钟；</p>
<p>2、中断延时将会增加，当WIC或者SRPG使用的时候；</p>
<p>3、当有外部调试器连接的时候，通常禁用掉电功能；这是因为在处理器内核处于睡眠模式的时候，外部的调试器也需要访问处理器；</p>
<h2 id="Software-power-saving-approach"><a href="#Software-power-saving-approach" class="headerlink" title="Software power-saving approach"></a>Software power-saving approach</h2><p>软件开发的过程中，需要对如下场景做决策：</p>
<ul>
<li><p>程序快速运行，并尽可能的进入低功耗模式;</p>
</li>
<li><p>程序慢速运行；</p>
</li>
</ul>
<p>对于这个问题的分析，并没有一个固定的准则，原因如下：</p>
<p>1、如果振荡器的功耗很高，那么慢速时钟可能是减低功耗的方法，但是这会增加中断延时以及整体的漏电流；</p>
<p>2、如果eflash的漏电流很大，在程序快速运行然后进入低功耗模式的时候，可能是降低功耗的一种方法，但是其peak power会更高；</p>
<h1 id="Cortex-M-processor-characteristics-that-enable-low-power-designs"><a href="#Cortex-M-processor-characteristics-that-enable-low-power-designs" class="headerlink" title="Cortex-M processor characteristics that enable low-power designs"></a>Cortex-M processor characteristics that enable low-power designs</h1><h2 id="High-code-density"><a href="#High-code-density" class="headerlink" title="High code density"></a>High code density</h2><p>Cortex-M系列的处理器使用的是16-bits&#x2F;32bits混合指令集，其代码密度更高，在低功耗方面带来的好处就是，可以使用更小的ROM&#x2F;Flash，从而降低功耗；</p>
<p>除了功耗方面的好处之外，更小的ROM&#x2F;eflash可以降低成本；</p>
<h2 id="Short-pipeline"><a href="#Short-pipeline" class="headerlink" title="Short pipeline"></a>Short pipeline</h2><p>除了Cortex-M7之外的大多数Cortex-M系列处理器，其流水线大多数都很短（2-3级），这样的处理器其好处就是（假设不考虑分支预测逻辑）：</p>
<ul>
<li>具有较低的分支代价branch penalty；</li>
<li>减少了分支阴影branch shadow；</li>
</ul>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240724173005520.png" class="">

<blockquote>
<p>分支惩罚是指当分支条件不满足时，处理器需要清空流水线并重新开始执行的时间成本</p>
<p>分支阴影（Branch shadows）指的是在处理器执行分支指令后，预先获取的指令</p>
<p>如图所示，Cortex-M0+ 和 Cortex-M23  处理器中，流水线只有2级，分支阴影会被降到只有一个word大小；</p>
<p>分支阴影的size可能和流水线的级数有关； </p>
</blockquote>
<h2 id="Instruction-fetch-optimizations"><a href="#Instruction-fetch-optimizations" class="headerlink" title="Instruction fetch optimizations"></a>Instruction fetch optimizations</h2><p>虽然有些指令是16位，但是Cortex-M处理器在大多数情况下以32bits的方式获取指令。这意味着获取每条指令的时候，Cortex-M处理器最多可以获取两条指令，并且指令fetch接口可以在不需要时处于非活动状态，这样可以降低程序存储器访问的功耗；</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240724194003374.png" class="">





<h1 id="System-level-design-considerations"><a href="#System-level-design-considerations" class="headerlink" title="System-level design considerations"></a>System-level design considerations</h1><h2 id="Low-power-designs-overview"><a href="#Low-power-designs-overview" class="headerlink" title="Low-power designs overview"></a>Low-power designs overview</h2><p>低功耗本身是一个非常大的话题。除了利用CORE本身的睡眠模式之外，芯片的其他部分都会对低功耗产生影响。例如，可以用clock gating技术，此外如果某些外设不用的情况下，还可以关闭电源。</p>
<h2 id="Clock-sources"><a href="#Clock-sources" class="headerlink" title="Clock sources"></a>Clock sources</h2><p><font color=blue>有一个低功耗的时钟源非常重要</font>。很多设计都需要一个持续工作的32KHz常开时钟源，如果这个时钟源的功耗很高，那么将会对系统功耗产生很严重的影响。理想情况下，32KHz需要超低功耗的特性，在工作电压变化很大的情况下也能正常工作。</p>
<p><font color=blue>时钟晶振的工作范围选择也很重要</font>，如果微处理器产品运行在100MHz，如果使用一个100Mhz的晶振，它意味着会以100Mhz running all the time因此会消耗大量的power。一次通常会使用一个低频率的时钟晶振+PLL去产生高频率的时钟源。</p>
<h2 id="Low-power-memories"><a href="#Low-power-memories" class="headerlink" title="Low-power memories"></a>Low-power memories</h2><ul>
<li><p>memory macros 在设计中考虑了多种睡眠&#x2F;保持模式，并提供了各种<code>“钩子”（hooks）</code>来允许系统设计者<font color=blue>将内存的低功耗状态与系统的睡眠模式进行关联。但是需要注意睡眠模式功耗和唤醒延迟之间存在的权衡。</font></p>
</li>
<li><p>eflash 可以选择关闭电源，因为其数据不会被丢失。<font color=blue>但是需要注意当闪存重新上电时，会产生一个瞬时的电流峰值，这被称为 in-rush current 或 current spike；这个电流峰值可能会导致电源线上的电压瞬时下降；电压下降可能会导致芯片中其他电路或模块出现工作不正常的问题，例如可能导致微处理器（或其他处理器）在重新启动时失去部分电源；</font></p>
</li>
<li><p>某些处理器允许软件在掉电之前向闪存写入数据，目的是让SRAM中的关键数据在上电会被恢复。当替换电池的时候，可能需要这样的操作。</p>
</li>
</ul>
<h2 id="cache"><a href="#cache" class="headerlink" title="cache"></a>cache</h2><p>系统中加入cache，虽然会增加芯片面积，漏电流以及对电源的需求，但是在一些情况下</p>
<ul>
<li>可以降低功耗，因为避免频繁访问eflash，访问flash的开销是非常巨大的；</li>
<li>可以增加系统的整体性能，因为访问flash的速度是很慢的；</li>
</ul>
<h2 id="Low-power-analog-components"><a href="#Low-power-analog-components" class="headerlink" title="Low-power analog components"></a>Low-power analog components</h2><p>在睡眠模式的时候，有很多的模拟组件是开着的：</p>
<ul>
<li><p>32kHz振荡器：这是一种低频振荡器，通常用于实时时钟（RTC，Real-Time Clock）和定时器。它的低频率特性使其在功耗上比高频率振荡器更为节能，适合在系统的低功耗模式（如睡眠模式）下运行。</p>
</li>
<li><p>实时时钟（RTC）：RTC是嵌入式系统中用于跟踪日期和时间的设备或模块。即使系统进入睡眠模式，RTC通常也需要保持运行，以便能够在系统唤醒时继续提供准确的时间信息。</p>
</li>
<li><p>低电压检测器（brown-out detector）：这是一种检测电源电压是否低于安全工作范围的电路。它通常会在电源电压低于规定值时发出警告或者复位系统，以防止芯片和周边电路因电压不稳定而受损。</p>
</li>
<li><p>部分I&#x2F;O引脚：在睡眠模式下，有些输入&#x2F;输出引脚可能需要保持活动状态，特别是当它们用于外部中断检测时。这意味着即使系统处于低功耗模式，这些引脚需要能够接收并响应来自外部的信号变化。</p>
</li>
</ul>
<p>很多I&#x2F;O引脚具有可配置的功耗模式，可以通过调整驱动强度和翻转速度来降低功耗。系统设计人员可以通过引入寄存器来控制这些配置信号；</p>
<h2 id="Maximizing-clock-gating-opportunities"><a href="#Maximizing-clock-gating-opportunities" class="headerlink" title="Maximizing clock gating opportunities"></a>Maximizing clock gating opportunities</h2><p>在系统设计中，也可以通过clock gating增加时钟门控单元以降低动态功耗。ARM的Corstone Foundation IP &#x2F; Cortex-M System Design Kit   中提供的AHB to APB bridge  就有一个<code>APBACTIVE </code>信号，当bridge上没有transaction时，就可以利用此信号去做门控，关闭APB外设时钟；</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240725171927479.png" class="">



<h2 id="Sleep-mode-that-completely-powers-down-the-processor"><a href="#Sleep-mode-that-completely-powers-down-the-processor" class="headerlink" title="Sleep mode that completely powers down the processor"></a>Sleep mode that completely powers down the processor</h2><p>Cortex-M处理器允许完全掉电，并且能被某些时间唤醒，但是需要注意如下两点：</p>
<p>1、处理器的状态会丢失，因此软件在执行掉电之前必须将处理器中关键的数据保存的状态保持SRAM中；</p>
<p>2、系统设计需要额外的硬件逻辑去处理硬件唤醒时间；</p>
<p>硬件逻辑需要完成如下任务：</p>
<p>1、向PMU发送唤醒信号，恢复处理器的供电；</p>
<p>2、复位处理器系统，（不对状态保持memory和寄存器进行复位）；</p>
<p>3、释放reset，让处理器boot-up并执行软件程序；</p>
<p>这样的一个系统，其框架大致如图所示：</p>
<img src="/2024/07/02/Low-power-support%EF%BC%881%EF%BC%89/image-20240725174130100.png" class="">

<p>1、电源控制，允许软件主动选择进入哪一种睡眠模式（例如是否在低功耗的时候掉电）</p>
<p>2、复位信息寄存器，允许软件决定是否进入冷启动或者暖启动；</p>
<blockquote>
<p>冷启动（Cold Boot）和暖启动（Warm Boot）是两种不同的系统启动方式，它们的主要区别在于系统在启动过程中是否经历了完全的电源断电。</p>
<ul>
<li><p>冷启动指的是系统在完全断电后重新上电启动</p>
</li>
<li><p>暖启动是指系统在不断电的情况下重新启动</p>
</li>
</ul>
</blockquote>
<p>3、状态保持SRAM，用于保存关键数据；</p>
<p>4、事件唤醒检测；</p>
<p><font color=blue>由于唤醒的过程需要时间，因此必须保存wake-up event ，以便软件有时间启动NIVC，然后由NVIC处理；</font></p>
<p>DAP(debug access port)有两种使用方法：</p>
<p>1、将DAP放在always-on power-domain，允许调试器连接的时候去唤醒处理器；</p>
<p>2、先使用其他的方式去唤醒，然后再连接调试器；</p>
<p>这种掉电的方式，其缺点是处理器必须先boot-up，然后才能处理中断。可以通过将处理器关键的状态保存在retention 的sram中，这种方式，就可以跳过C startup就可以及时响应中断。一般来说，关键的信息包括如下内容：</p>
<ul>
<li>NVIC的配置</li>
<li>MPU的配置</li>
<li>ststick的配置</li>
<li>MPS和PSP的配置</li>
<li>特殊寄存器的配置，PRIMASK, FAULTMASK, BASEPRI, etc.  </li>
<li>FPU的配置</li>
</ul>
<blockquote>
<p><font color=red>软件流程上具体是如何做的？？</font></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/07/01/posim%E4%BB%BF%E7%9C%9Ftiming-violation%E9%97%AE%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/01/posim%E4%BB%BF%E7%9C%9Ftiming-violation%E9%97%AE%E9%A2%98/" class="post-title-link" itemprop="url">posim仿真timing violation问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-07-01 23:41:58" itemprop="dateCreated datePublished" datetime="2024-07-01T23:41:58+08:00">2024-07-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-07-08 09:15:29" itemprop="dateModified" datetime="2024-07-08T09:15:29+08:00">2024-07-08</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IC%E8%AE%BE%E8%AE%A1%E6%B5%81%E7%A8%8B/" itemprop="url" rel="index"><span itemprop="name">IC设计流程</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/IC%E8%AE%BE%E8%AE%A1%E6%B5%81%E7%A8%8B/posim/" itemprop="url" rel="index"><span itemprop="name">posim</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/07/01/posim%E4%BB%BF%E7%9C%9Ftiming-violation%E9%97%AE%E9%A2%98/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/07/01/posim%E4%BB%BF%E7%9C%9Ftiming-violation%E9%97%AE%E9%A2%98/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>第一种：sync电路第一级不用care，添加async list</p>
<hr>
<p>case1：sync电路第一级</p>
<p>不用care，添加async list</p>
<hr>
<p>case2：module内部reg发生了timing，但是module输出没有X态</p>
<p>这种X太不会传播，不应影响到功能；</p>
<hr>
<p>case3：module reg发生了timing violation，X态会发生传播</p>
<p>例如外部reset拉低的时候，可能会导致时钟产生毛刺（例如，dtc mux切换导致）</p>
<p>SMIC工艺的寄存器，碰到这样的毛刺时钟，就会导致timing violation，然后会有X态传播；</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/07/01/%E8%BD%AF%E4%BB%B6%E6%96%AD%E7%82%B9/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/01/%E8%BD%AF%E4%BB%B6%E6%96%AD%E7%82%B9/" class="post-title-link" itemprop="url">软件断点</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-07-01 20:58:28 / 修改时间：21:32:15" itemprop="dateCreated datePublished" datetime="2024-07-01T20:58:28+08:00">2024-07-01</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%BA%E4%BA%8ECortex-M%E7%9A%84SoC%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">基于Cortex-M的SoC设计</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/07/01/%E8%BD%AF%E4%BB%B6%E6%96%AD%E7%82%B9/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/07/01/%E8%BD%AF%E4%BB%B6%E6%96%AD%E7%82%B9/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>debug操作中，通常会涉及到硬件断点和软件断点；</p>
<p>硬件断点比较好理解，就是通过硬件比较器实现：PC值 &#x3D;&#x3D; 指定的值，Halt CPU</p>
<p>软件断点如何理解？这里探索下</p>
</blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">apb_write(ADDR_DEMCR,apb_read(ADDR_DEMCR) | <span class="number">0x00010000</span>);</span><br><span class="line">apb_read(ADDR_DEMCR);</span><br><span class="line"></span><br><span class="line">user_fputc(<span class="string">&quot;\nbefore bkpt \n&quot;</span>);</span><br><span class="line">__asm <span class="title function_">volatile</span> <span class="params">(<span class="string">&quot;bkpt #0&quot;</span>)</span>;</span><br><span class="line">user_fputc(<span class="string">&quot;\nafter bkpt \n&quot;</span>);</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/28/Debug-integration-with-Cortex-M-processor-systems%EF%BC%881%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/28/Debug-integration-with-Cortex-M-processor-systems%EF%BC%881%EF%BC%89/" class="post-title-link" itemprop="url">5 Debug integration with Cortex-M processor systems（1）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-28 17:13:03" itemprop="dateCreated datePublished" datetime="2024-06-28T17:13:03+08:00">2024-06-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-07-01 21:29:54" itemprop="dateModified" datetime="2024-07-01T21:29:54+08:00">2024-07-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%BA%E4%BA%8ECortex-M%E7%9A%84SoC%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">基于Cortex-M的SoC设计</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/28/Debug-integration-with-Cortex-M-processor-systems%EF%BC%881%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/28/Debug-integration-with-Cortex-M-processor-systems%EF%BC%881%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Overview-of-debug-and-trace-features"><a href="#Overview-of-debug-and-trace-features" class="headerlink" title="Overview of debug and trace features"></a>Overview of debug and trace features</h1><p>大多数的Cortex-M系统，都会集成debug和trace特性，不仅方便软件开发做调试，也对flash program调试和诊断数据的生成很有用。</p>
<p>debug功能有如下特性：</p>
<ul>
<li>访问memory space。处理器正在运行的时候，debug也能访问</li>
<li>断点事件可以用于halt处理器<ul>
<li>硬件断点：使用的是硬件比较器去比较PC和断点地址，硬件断点的数量是有限的；</li>
<li>软件断点：使用BKPT指令去触发断点中断，然后通过debug monitor进行捕获；</li>
</ul>
</li>
</ul>
<blockquote>
<p>思考：</p>
<p><font color=red>软件断点的工作机制？</font></p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/26/C%E8%AF%AD%E8%A8%80%E7%9A%84%E5%8F%98%E9%87%8F%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/26/C%E8%AF%AD%E8%A8%80%E7%9A%84%E5%8F%98%E9%87%8F%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE/" class="post-title-link" itemprop="url">C语言的变量存储位置</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-26 15:01:41 / 修改时间：17:34:35" itemprop="dateCreated datePublished" datetime="2024-06-26T15:01:41+08:00">2024-06-26</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8FC%E7%A8%8B%E5%BA%8F/" itemprop="url" rel="index"><span itemprop="name">嵌入式C程序</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%B5%8C%E5%85%A5%E5%BC%8FC%E7%A8%8B%E5%BA%8F/%E7%BC%96%E8%AF%91%E9%93%BE%E6%8E%A5/" itemprop="url" rel="index"><span itemprop="name">编译链接</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/26/C%E8%AF%AD%E8%A8%80%E7%9A%84%E5%8F%98%E9%87%8F%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/26/C%E8%AF%AD%E8%A8%80%E7%9A%84%E5%8F%98%E9%87%8F%E5%AD%98%E5%82%A8%E4%BD%8D%E7%BD%AE/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>嵌入式软件通常会涉及到程序变量的分配位置，此处做一个总结；</p>
</blockquote>
<p>C程序中的数据分为：</p>
<ul>
<li>变量<ul>
<li>栈区：由编译器自动分配释放</li>
<li>堆区： 一般由程序员使用malloc函数分配释放，若程序员不释放，程序结束时可能由OS回收</li>
<li>全局&#x2F;静态变量存储区：存储全局变量以及静态变量（会对全局&#x2F;静态变量做初始化的和未初始化的区分）</li>
</ul>
</li>
<li>常量（字面常量）<ul>
<li>常量存储器：存放字面常量</li>
</ul>
</li>
</ul>
<p><font color=blue>程序会将变量搬运到SRAM区域；</font></p>
<p><font color=blue>常量仍然会在Flash或者ROM等NVM介质中；</font></p>
<p>参考博客：</p>
<p>1、<a target="_blank" rel="noopener" href="https://blog.csdn.net/zy13270867781/article/details/78266675">c中各个变量存储的位置</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/" class="post-title-link" itemprop="url">4 Building simple bus systems for Cortex-M processors（1）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-25 17:44:15" itemprop="dateCreated datePublished" datetime="2024-06-25T17:44:15+08:00">2024-06-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-07-12 10:17:46" itemprop="dateModified" datetime="2024-07-12T10:17:46+08:00">2024-07-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%BA%E4%BA%8ECortex-M%E7%9A%84SoC%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">基于Cortex-M的SoC设计</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>研究怎样基于Cortex-M处理器构建bus system：</p>
<p>Cortex-M0, Cortex-M0+,<br>Cortex-M1, and Cortex-M3&#x2F;M4   </p>
</blockquote>
<h1 id="Introduction-to-the-basics-of-bus-design"><a href="#Introduction-to-the-basics-of-bus-design" class="headerlink" title="Introduction to the basics of bus design"></a>Introduction to the basics of bus design</h1><p>system bus有几个基本的设计原则：</p>
<ul>
<li>如果是哈佛结构，bus系统需要保证指令和数据的同时访问；</li>
<li>使用default slave IP去处理违法地址的访问；</li>
<li>很多Cortex-M处理器，其中断向量表的起始地址在0x0000_0000，因此需要保证程序被加载到这个地址；</li>
<li>访问mem的wait state数量要尽可能少，尤其是对于没有cache的处理器，访问mem的wait state会影响性能，功耗以及中断响应延时；</li>
<li>尽量保证主系统bus有尽可能少的slave；</li>
</ul>
<p>system bus和peripheral bus分开的好处：</p>
<ul>
<li>降低对system bus的max clock frequency的影响；</li>
<li>外设bus和system bus可以跑在不同的频率；</li>
<li>外设协议更简单；</li>
</ul>
<blockquote>
<p>NOTE:</p>
<p>most of the peripherals that do not need low latency accesses (e.g., SPI, I2C, UART) can be placed in separated peripheral buses. Some peripherals like GPIO can gain the benefit of lower access latency, so some GPIO blocks are placed system AHB or single-cycle I&#x2F;O port interface (available on<br>Cortex-M0+ and Cortex-M23 processors).  </p>
</blockquote>
<h1 id="Building-a-simple-Cortex-M0-system"><a href="#Building-a-simple-Cortex-M0-system" class="headerlink" title="Building a simple Cortex-M0 system"></a>Building a simple Cortex-M0 system</h1><img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240625175846130.png" class="">





<h1 id="Building-a-simple-Cortex-M0-system-1"><a href="#Building-a-simple-Cortex-M0-system-1" class="headerlink" title="Building a simple Cortex-M0+ system"></a>Building a simple Cortex-M0+ system</h1><img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240625180447010.png" class="">



<p><font color=blue>和Cortex-M0系统非常类似，在如下方面有所不同：</font></p>
<ul>
<li><font color=blue>Optional single-cycle I&#x2F;O port (IOP) interface for low latency peripheral register accesses;  </font></li>
<li><font color=blue>Optional Micro Trace Buffer (MTB).  </font></li>
</ul>
<blockquote>
<p>NOTE：</p>
<p>&#x3D;&#x3D;&gt;IOP</p>
<p>1、如果想要使用single-cycle I&#x2F;O port interface  ，需要调整对应的外设时序；</p>
<p>2、需要有一个简单的IOP decoder，去告诉CPU哪些地址通过IOP访问，哪些地址通过AHB-Lite访问；</p>
<p>&#x3D;&#x3D;&gt;MTB</p>
<p>1、用于提供低成本的指令trace；在AHB和SRAM中间；</p>
<p>norm情况下，就可以看成是一个AHB2SRAM的bridge；</p>
<p>在进行指令trace的时候，debugger会program MTB从SRAM中划分一块空间用于存储数据；</p>
<p>2、MTB有一个和处理器连接的trace 接口，用于接收处理器trace数据，以及生成debug事件（halting request）到处理器；</p>
<p>3、一般来说MTB可以配置成环形buffer从而保存最近执行的指令数据；</p>
</blockquote>
<ul>
<li><font color=blue>Cortex-M0+支持特权级访问和非特权级访问；系统集成者也可以考虑配置MPU去支持特权&#x2F;非特权访问；</font></li>
</ul>
<blockquote>
<p>这样就能够阻止非特权级别的代码去访问特权级别的memory；</p>
<p>从功能安全级别的角度考虑：</p>
<ul>
<li>用于系统控制的外设寄存器应该设置为特权级别访问；</li>
<li>非特权级别的AHB access 特权级别的device，地址decoder应该select default slave去产生bus error；</li>
</ul>
</blockquote>
<h1 id="Building-a-simple-Cortex-M1-system"><a href="#Building-a-simple-Cortex-M1-system" class="headerlink" title="Building a simple Cortex-M1 system"></a>Building a simple Cortex-M1 system</h1><p>Cortex-M1和Cortex-M0的类似的features：</p>
<ul>
<li>不支持特权&#x2F;非特权级别的操作；</li>
<li>仅仅只有一个AHB接口；</li>
</ul>
<p>Cortex-M1和Cortex-M0的不同的features：</p>
<ul>
<li>Cortex-M1支持ITCM和DTCM；</li>
<li>没有sleep mode；</li>
</ul>
<p><font color=blue>Cortex-M1一般用作FPGA的开发；</font></p>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240625203309033.png" class="">



<h1 id="Building-a-simple-Cortex-M3-Cortex-M4-system"><a href="#Building-a-simple-Cortex-M3-Cortex-M4-system" class="headerlink" title="Building a simple Cortex-M3&#x2F;Cortex-M4 system"></a>Building a simple Cortex-M3&#x2F;Cortex-M4 system</h1><p>Cortex-M3&#x2F;Cortex-M4处理器采用哈佛架构，而且有3个AHB总线接口以及一个APB总线接口；</p>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240625204223785.png" class="">



<p><font color=blue>一个典型的Cortex-M3&#x2F;M4 system design ：</font></p>
<ul>
<li><font color=blue>program image 被放在CODE区域；</font></li>
<li><font color=blue>sram和外设通过系统总线连接；通常地址0x2000_0000分配SRAM，0x4000_0000分配外设；因为方便软件开发者使用side-band特性；</font></li>
</ul>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240625210218086.png" class="">

<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240625210337572.png" class="">

<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240625210426184.png" class="">

<h2 id="I-CODE和D-CODE的处理方式1：无系统cache"><a href="#I-CODE和D-CODE的处理方式1：无系统cache" class="headerlink" title="I-CODE和D-CODE的处理方式1：无系统cache"></a>I-CODE和D-CODE的处理方式1：无系统cache</h2><p><font color=blue>将I-CODE和D-CODE分开的目的，添加一个常量数据cache，当指令访问flash，由于wait state而等待的时候，常量数据仍然可以从cache中read；</font></p>
<p><font color=blue>解释如下：</font></p>
<p><font color=blue>&#x3D;&#x3D;》首先只有一个总线的方案</font></p>
<ul>
<li>一般来说，flash的速度为30MHz-50MHz，远小于处理器的速度(超过100MHz)。</li>
<li>通常会选择位宽更大以及有prefetch buffer的flash，<font color=blue>顺序执行的指令会被prefetch</font>，处理器更多时候会从prefetch buffer中读取指令，从而提供性能；</li>
</ul>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240626201216548.png" class="">

<p>但是程序中还有很多常量，这些常量的访问往往是非顺序的，因此prefetch的性能会大大降低；</p>
<p>往极端的方向思考：如果在prefetch刚开始的时候，发生了读常量的操作，需要等待的时间很更久；</p>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240626223223336.png" class="">

<p><font color=blue>&#x3D;&#x3D;》过渡到两个总线的方案</font></p>
<p><font color=blue>为了解决上述的问题，一种解决方案是，将数据访问和指令访问分开，然后在数据访问总线上添加一个小的data cache；</font></p>
<blockquote>
<p>数据访问一开始的时候会将变量搬运到SRAM中；</p>
<p>之后程序的运行，即访问常量的时候，会通过D-CODE访问；</p>
</blockquote>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240626224644608.png" class="">

<blockquote>
<p>这是将一条程序总线分成I-CODE和D-CODE两条总线的初衷；</p>
</blockquote>
<h2 id="I-CODE和D-CODE的处理方式2：有系统cache"><a href="#I-CODE和D-CODE的处理方式2：有系统cache" class="headerlink" title="I-CODE和D-CODE的处理方式2：有系统cache"></a>I-CODE和D-CODE的处理方式2：有系统cache</h2><p><font color=blue>上述方案没有考虑系统级别的cache，如果有系统级别的cache，指令访问就不会因为flash的速度低而等待很久，因此可以不需要上述flash访问加速的机制，</font></p>
<ul>
<li>flash的prefetch机制</li>
<li>常量cache机制</li>
</ul>
<p><font color=blue>可以考虑直接将I-CODE和D-CODE总线进行merge</font></p>
<p>为了进行merge，Cortex-M3和Cortex-M4的产品交付包中包含两个组件：</p>
<h3 id="Code-mux-component"><a href="#Code-mux-component" class="headerlink" title="Code mux component"></a>Code mux component</h3><p>门数量非常少，为了使用这个组件，I-CODE和D-CODE只能同时有一个active，通过配置DNOTITRANS  输入端口需要为1</p>
<p>（防止在D-CODE进行transfer的时候，I-CODE再生成transfer）；</p>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240626231517758.png" class="">

<h3 id="Flash-mux-component"><a href="#Flash-mux-component" class="headerlink" title="Flash mux component"></a>Flash mux component</h3><p>这个组件内部有仲裁机制；这个组件在CODE region还有其他slave组件的时候，非常有用，因为I-CODE和D-CODE可以同时发出访问；</p>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240626233511046.png" class="">



<p><font color=blue>有系统cache和上述组件的时候，如果CODE区域没有其他组件，架构可以考虑如下：</font></p>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240626234311838.png" class="">

<blockquote>
<p>对于上述系统架构，I-CODE和D-CODE都是访问flash，在有系统cache的情况下，将I-CODE和D-CODE分开之后的收益不是很大了；</p>
<p>假设CODE区域没有其他Slave组件，其将I-CODE和D-CODE分开的初衷是，防止指令访问的wait state也阻碍了数据访问，大大降低系统性能；</p>
<p>但是现在有cache的情况下，指令访问不会有太多的wait state，因此就可以不用分开；</p>
<p>新一代的处理器，例如M33和M35P，I-CODE和D-CODE已经merge了，用于降低系统集成的复杂度以及low power。</p>
</blockquote>
<p><font color=blue>cpu cache VS flash cache：</font></p>
<ul>
<li>cache如果放在cpu门口，那么只能CPU使用，其他master无法使用；</li>
<li>cache放在flash附近，其和flash的接口可以使用更大的数据位宽；</li>
<li>cache放在flash附近，cpu访问的时候就需要经过总线；</li>
</ul>
<p><font color=blue>NOTE：</font></p>
<ul>
<li><p>在Cortex-M3&#x2F;M4处理器中，通过S-BUS取指令，需要寄存一拍才能送到instruction fetch interface  ；通过I-BUS获取指令，不需要寄存，可以直接送到instruction fetch interface ，因此如果使用S-BUS执行指令的时候，性能会下降；</p>
</li>
<li><p>系统外设一般系统通过S-BUS访问，而不是PPB；</p>
<ul>
<li>PPB只能特权级别访问；</li>
<li>永远是小端模式；</li>
<li>访问行为是Strongly Ordered (no other data memory access can start until the current data access finished);  </li>
<li>没有bit-band特性；</li>
<li>只支持32bits访问，非对齐访问会出现未知结果；</li>
<li>仅仅只有Core能访问；</li>
</ul>
</li>
</ul>
<blockquote>
<p>思考：</p>
<p><font color=red>什么是Strongly Ordered？难道AHB不是strongly Ordered？</font></p>
<p>Strongly Ordered是一种存储器的访问模型；</p>
</blockquote>
<h1 id="Handling-multiple-bus-masters"><a href="#Handling-multiple-bus-masters" class="headerlink" title="Handling multiple bus masters"></a>Handling multiple bus masters</h1><p>&#x3D;&#x3D;》在很多的微处理器中，其实会有多个Master，例如：</p>
<ul>
<li>DMA</li>
<li>高速外设：USB controller，Ethernet interface等等</li>
</ul>
<p>这些模块有master interface，能主动发起transfer；也有slave interface，为了配置其工作参数；</p>
<p>&#x3D;&#x3D;》为了处理器多个Master的情况，ARM提供了不同的IP</p>
<ul>
<li>Simple AHB master multiplexers  ，多个Master只能有一个占用总线，考虑到带宽的问题，通常只能支持2-3个master</li>
<li>Configurable AHB Bus Matrix components（ 支持多个Master并发访问）</li>
</ul>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240627212730972.png" class="">

<blockquote>
<p>这种设计适合对系统带宽要求不高的场景；</p>
<p>如果对系统带宽有着严格的要求，可以采用如下的设计；</p>
</blockquote>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240627212849347.png" class="">

<p><font color=blue>Bus Matrix支持稀疏的配置，内部有default slave，灵活性很高，但是在进行Master间切换的时候，会引入latency。</font></p>
<p>可以通过 减少arbiter切换master 来对latency进行优化：</p>
<ul>
<li>定制化逻辑，例如定义默认选择的master</li>
<li>当bus idle的时候，强制将地址设置为特定的值</li>
</ul>
<blockquote>
<p>NOTE:</p>
<p><font color=red>上面说的两种优化方式都不太懂，BusMatrix组件需要好好的研究下！！！</font></p>
</blockquote>
<p>&#x3D;&#x3D;》从安全的角度来考虑，例如DMA这种Master的Slave 接口，通常要保证特权级别访问；</p>
<p>不然非特权级别的程序可能会利用DMA，bypass memory protect</p>
<h1 id="Exclusive-access-support"><a href="#Exclusive-access-support" class="headerlink" title="Exclusive access support"></a>Exclusive access support</h1><p>Armv7-M 和 Armv8-M  架构的处理器都支持互斥访问操作。</p>
<hr>
<p>&#x3D;&#x3D;》多核系统</p>
<p><font color=blue>如果多核系统要支持互斥访问操作，需要集成global exclusive access monitors ；</font></p>
<p>global exclusive access monitors需要放在bus matrix或者AHB master multiplexer 的下游；</p>
<p>总线组件也需要提供HMASTER，让global exclusive access monitor  知道是哪一个Master产生了transfer；</p>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240627220026567.png" class="">

<p><font color=blue>符合如下情况，需要添加global exclusive access monitors：</font></p>
<p>1、可能存放信号量数据；</p>
<p>2、可能被多核互斥访问；</p>
<p>只有在多核系统中才需要global exclusive access monitors；</p>
<hr>
<p>&#x3D;&#x3D;》单核系统</p>
<p>单核系统中，即使有多个Master，软件也可以控制不会同时发生多个Master访问信号量数据的情况，因此不需要global exclusive access monitors</p>
<p><font color=blue>单核系统中，如果使用的是M3&#x2F;M4&#x2F;M7，其会有专有的互斥访问handshake信号(EXREQ and EXRESP)  ：</font></p>
<ul>
<li>总线上如果有SRAM，就需要将EXRESP tie low，不然OS系统的信号量功能会一直返回fail</li>
<li>总线上如果只有NVM，或者外设，此时可以将EXRESP tie high ，表示不支持互斥访问；</li>
</ul>
<p><font color=blue>单核系统中，如果使用的是M23&#x2F;M33&#x2F;M35P，使用的是标准AMBA5 AHB互斥访问信号，(HEXCL and HEXOKAY)  ：</font></p>
<ul>
<li>如果总线包含SRAM，需要对HEXOKAY做简单的glue逻辑；</li>
<li>如果总线上如果只有NVM，或者外设，可以将HEXOKAY tie low，表示不支持互斥访问；</li>
</ul>
<h1 id="Address-remap"><a href="#Address-remap" class="headerlink" title="Address remap"></a>Address remap</h1><p>Address remap是基于Cortex-M的MCU中一种常见的system design technique  ；一般用来支持多个boot阶段或者多种boot mode；</p>
<p>举例说明：</p>
<p>假设一个基于Cortex-M0的MCU可能需要支持boot loader；</p>
<p>&#x3D;&#x3D;》address remap需要完成如下动作：</p>
<p>1、startup阶段将boot loader ROM放到0x0000_0000处；</p>
<p>2、之后将embedded flash映射到0x0000_0000，用于执行用户程序；</p>
<p>&#x3D;&#x3D;》为了支持address remap，需要寄存器去控制系统address decoder的行为</p>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240628105739745.png" class="">

<p>0、在boot的时候，REMAP是出于active的状态，即ROM会映射到0x0000_0000地址处；</p>
<p>1、处理器读取的是ROM的中断向量表（按照存放位置是0x0010_0000进行编译），执行的是ROM的reset handler（在0x0010_0000地址处执行）</p>
<p>2、ROM的reset handler执行结束之后：</p>
<ul>
<li>将REMAP disable，（0x0000_0000映射的就是Flash usercode的中断向量表）；</li>
<li>读取Flash usercode vector table中的MSP并进行配置；</li>
<li>读取Flash usercode vector table中的reset handler的地址，并进行跳转；</li>
</ul>
<p>有如下几点说明：</p>
<ul>
<li>Flash在boot阶段的时候，也可以REMAP，这样romcode是可以对Flash中的程序做一些操作的；否则，REMAP之后，Flash的code就不可见；</li>
<li>remap控制寄存器：<ul>
<li>仅支持特权级别访问；</li>
<li>通过power on reset控制，这样在boot的时候，仅执行一次；（例如，debugger在使用SYSRESETREQ field in AIRCR  进行复位的时候，不会再次执行；）</li>
<li>有些系统中，REMAP只能软件被deactive而不能被active，或者说，bootrom仅仅在boot阶段可见，在REMAP关闭之后，rom就不可见，为了功能安全；</li>
</ul>
</li>
</ul>
<p>AHB BusMatrix IP是支持REMAP操作的；</p>
<ul>
<li><p>但是如果处理器支持VTOR，那么就不需要使用REMAP，因为其可以通过将VTOR指向某块区域；</p>
</li>
<li><p>Cortex-M7&#x2F;M23&#x2F;M33处理器支持启动时，中断向量表的位置是可配置的；</p>
</li>
</ul>
<blockquote>
<p>思考：</p>
<p>1、VTOR寄存器的作用？</p>
<p>指定中断向量表的位置；</p>
<p>2、<font color=red>一般在什么场景中会利用VTOR寄存器？</font></p>
</blockquote>
<h1 id="AHB-based-memory-connection-versus-TCM"><a href="#AHB-based-memory-connection-versus-TCM" class="headerlink" title="AHB-based memory connection versus TCM"></a>AHB-based memory connection versus TCM</h1><p><font color=blue>有些处理器可能会使用TCM；如果没有TCM接口，就需要使用AHB去访问系统SRAM；</font></p>
<p>就性能而言（且不考虑AHB访问时的wait state），TCM接口和AHB接口访问SRAM，在read access上，latency是相同的；</p>
<p>写访问时间可能会有所不同，如下图所示：</p>
<img src="/2024/06/25/4-Building-simple-bus-systems-for-Cortex-M-processors%EF%BC%881%EF%BC%89/image-20240628133549414.png" class="">

<p>但是因为处理器的pipeline以及write buffer等技术，write access也可能被优化成一个Cycle完成；</p>
<p><font color=blue>使用TCM的最大的优点是，不用担心总线的wait states；最大的缺点是只有Core能访问；SRAM资源利用不充分</font></p>
<p><font color=blue>在有些设计场景中，需要使用TCM去获得一个确定的中断响应时间；</font></p>
<h1 id="Handling-of-embedded-flash-memories"><a href="#Handling-of-embedded-flash-memories" class="headerlink" title="Handling of embedded flash memories"></a>Handling of embedded flash memories</h1><h2 id="IP-requirements"><a href="#IP-requirements" class="headerlink" title="IP requirements"></a>IP requirements</h2><p>嵌入eflash受限于工艺节点；</p>
<p>需要eflash controller IP；</p>
<p>通常也需要system cache IP；</p>
<h2 id="Flash-programming"><a href="#Flash-programming" class="headerlink" title="Flash programming"></a>Flash programming</h2><p>eflash的memory是以page进行划分，因此eflash的操作也都是以page为单位；</p>
<p>做flash的program时，并不是直接将debugger和eflash controller连接，而是通过如下方式：</p>
<ul>
<li><p>将flash programming algorithm  程序加载到SRAM中</p>
</li>
<li><p>将要写入flash中的数据，放到SRAM中；</p>
</li>
<li><p>配置flash programming algorithm需要的信息；</p>
</li>
<li><p>PC设置到flash programming algorithm进行program；</p>
</li>
<li><p>一次program一个page，而且flash programming algorithm   可以对page内容进行verify；</p>
</li>
<li><p>debugger重复上述过程，直到完成对flash的编程；</p>
</li>
</ul>
<h2 id="Bringing-up-a-new-device-without-a-valid-program-image"><a href="#Bringing-up-a-new-device-without-a-valid-program-image" class="headerlink" title="Bringing up a new device without a valid program image"></a>Bringing up a new device without a valid program image</h2><p>如果eflash中没有任何程序，怎么启动Cortex-M MCU？</p>
<p>1、power on上电，此时flash中是空程序，会先发生hardfault，然后再lockup；</p>
<p>2、即使MCU处于lockup的状态，debugger仍然能够和MCU建立连接；</p>
<p>3、此时调试器可以使能reset vector catch  ，然后写AIRCR 寄存器进行软复位；处理捕获到reset release之后，进入halt状态；</p>
<p>4、debugger下载flash program algorithm以及程序镜像数据到SRAM，然后设置PC去启动flash program algorithm</p>
<p>5、当所有的flash程序program完毕之后，再次复位开始执行flash usercode；</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/" class="post-title-link" itemprop="url">3 AMBA/AHB/APB（3）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-20 23:49:32" itemprop="dateCreated datePublished" datetime="2024-06-20T23:49:32+08:00">2024-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-07-12 10:15:58" itemprop="dateModified" datetime="2024-07-12T10:15:58+08:00">2024-07-12</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%9F%BA%E4%BA%8ECortex-M%E7%9A%84SoC%E8%AE%BE%E8%AE%A1/" itemprop="url" rel="index"><span itemprop="name">基于Cortex-M的SoC设计</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Exclusive-access-operations"><a href="#Exclusive-access-operations" class="headerlink" title="Exclusive access operations"></a>Exclusive access operations</h1><h2 id="Introduction-to-exclusive-accesses"><a href="#Introduction-to-exclusive-accesses" class="headerlink" title="Introduction to exclusive accesses"></a>Introduction to exclusive accesses</h2><p><font color=blue>互斥访问对OS系统的的信号量操作至关重要，因为互斥访问能够检测出来RWM的访问冲突</font></p>
<blockquote>
<p>RWM的访问冲突能够在很多场景中出现：</p>
<ul>
<li>OS在RMW的中间发生时间片轮转&#x2F;中断 ,从而对进程进行切换</li>
<li>多处理器系统中，多个处理器同时执行RMW对同一个地址进行访问</li>
</ul>
</blockquote>
<p><font color=blue>为了能够对互斥访问进行处理，需要从如下几个方面考虑：</font></p>
<ol>
<li><font color=blue>互斥访问指令，Cortex处理器有LDREX以及STREX等互斥访问指令</font></li>
<li><font color=blue>bus接口需要有互斥访问信号，互斥访问信号在AMBA5 AHB才被正式引进，之前的Cortex-M处理器（M3&#x2F;M4&#x2F;M7）使用的是非标准的互斥访问sideband信号</font></li>
<li><font color=blue>系统级的monitor，对于多处理器系统，需要一个bus级别的全局互斥访问monitor，用来检测多个master之间的互斥访问冲突；多个global互斥访问monitor可以用来检测不同范围的互斥访问操作；</font></li>
</ol>
<blockquote>
<p>一些思考&amp;困惑：</p>
<p>1、互斥访问指令的设计意图是什么？和正常的读写指令有什么不一样？</p>
<p>我理解互斥访问指令，其目的就是告诉处理器这是一个RMW sequence，中间不能被打断；</p>
<p>执行这种指令的时候，需要互斥访问的sideband信号协同工作；</p>
</blockquote>
<p>&#x3D;&#x3D;》首先看下访问冲突的问题</p>
<p>信号量在操作系统中被用于资源管理，可以利用信号量确保同一时刻某一个硬件资源只能够被一个进程使用；</p>
<p>具体来说，OS使用一个内存变量（信号量）去追踪资源分配情况（系统资源是否已经被占用），应用程序通过调用API接口去互斥的访问该信号量；</p>
<blockquote>
<p>假设没有互斥访问操作，就会出现访问冲突，具体可看如下例子：</p>
<p>1、OS对进程切换的例子</p>
<p>。。。</p>
<p>2、多进程访问的具体例子</p>
<p>。。。</p>
</blockquote>
<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240623211132897.png" class="">



<p>&#x3D;&#x3D;》互斥访问操作的引入</p>
<p>为了解决这个问题，传统的处理器，例如Arm7TDMI   使用lock transfer确保总线在进行RMW操作的时候，不会被打断；但是lock传输在读写通道分离的高速传输总线协议上无法实现，因此互斥访问操作在Armv6架构被引入；</p>
<p>简单的互斥访问序列如下：</p>
<p>1、Processor X read semaphore data P with an exclusive load instruction;  </p>
<p>2、If the value of P is 0, Processor X write 1 to P with an exclusive store instruction;  </p>
<p>3、The exclusive store instruction returns a success or fail status. </p>
<ul>
<li>If the status is success, then the application task can continue the operation.<ul>
<li>If the status is fail, then it means there is a potential access conflict, and it needs to restart the RMW sequence. The store operation is blocked if the<br>exclusive store returns fail status.</li>
</ul>
</li>
</ul>
<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240623211247944.png" class="">



<p>为了确定返回状态，系统包含了两个互斥访问monitor：</p>
<p>1、Local exclusive access monitor – This hardware is inside the processor, and it triggers exclusive fail if there has been a context switch (including exception entry&#x2F;exit);  </p>
<p>2、Global exclusive access monitor – This hardware is at the bus level, and it triggers exclusive fail if another bus master has access to the address which is marked for exclusive access (when exclusive load is made).  </p>
<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240623211343345.png" class="">



<p>当处理器执行互斥访问操作的时候：</p>
<ul>
<li>If the local exclusive access monitor returns fail status – the exclusive store is blocked before it gets<br>to the bus interface level, so it won’t be carried out.</li>
<li>If the global exclusive access monitor returns fail status - the exclusive store is blocked by the global<br>exclusive store monitor, so the memory won’t get updated.</li>
<li>If either local or global exclusive access monitor return fail status, the write operation will not be<br>carried out, and the processor should retry the RMW sequence.</li>
</ul>
<h2 id="AHB5-exclusive-access-support"><a href="#AHB5-exclusive-access-support" class="headerlink" title="AHB5 exclusive access support"></a>AHB5 exclusive access support</h2><p>global exclusive access monitor除了标准的AMBA3 AHB-Lite信号之后，还需要</p>
<ul>
<li>HEXCL</li>
<li>HEXOKAY</li>
<li>HMASTER</li>
</ul>
<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240623211454371.png" class="">





<p>The address tag in the monitor does not necessarily record all bits of the address value. Typically, the<br>monitor can drop the lowest bits of the address as the exclusive fail information can be speculative:</p>
<ul>
<li>The data might be written with the same value.</li>
<li>Nearby data could have been accessed by a different bus master.</li>
</ul>
<blockquote>
<p>这段话不是很理解，需要结合具体的global monitor design才能理解</p>
</blockquote>
<p>互斥访问失败之后，不会有任何的系统性错误风险，最多只会牺牲点时间重新运行；</p>
<p>Exclusive Reservation Granule (ERG)  用来记录不同的master信息，通过HMASTER以及HADDR信号；</p>
<h2 id="Mapping-of-Cortex-M3-M4-M7-exclusive-access-signals-to-AHB5"><a href="#Mapping-of-Cortex-M3-M4-M7-exclusive-access-signals-to-AHB5" class="headerlink" title="Mapping of Cortex-M3&#x2F;M4&#x2F;M7 exclusive access signals to AHB5"></a>Mapping of Cortex-M3&#x2F;M4&#x2F;M7 exclusive access signals to AHB5</h2><p>Cortex-M3, Cortex-M4 and Cortex-M7  支持互斥访问指令，但是这些处理器在AMBA5 AHB之前release，因此他们使用的是非标准的互斥访问信号：</p>
<ul>
<li>EXREQ – same as HEXCL, an address phase signal to indicate exclusive load&#x2F;store accesses.  </li>
<li>EXRESP – exclusive fail status in the data phase (assert at the end of the data phase - opposite<br>polarity compared to HEXOKAY).</li>
</ul>
<p>因此在将这些处理器集成到AHB5 系统的时候，需要添加一些glue逻辑；</p>
<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240623211736465.png" class="">

<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240623211823114.png" class="">

<blockquote>
<p>思考：</p>
<p><font color=red>exclusive所需要的sideband控制信号EXREQ以及EXRESP和masterlock信号是不是功能上重复了？？</font></p>
<p>masterlock的使用场景也是防止RMW造成的冲突，但是这个功能exclusive指令已经完成了</p>
</blockquote>
<h1 id="AHB5-TrustZone-support"><a href="#AHB5-TrustZone-support" class="headerlink" title="AHB5 TrustZone support"></a>AHB5 TrustZone support</h1><p><font color=blue>AMBA 5 AHB的一个关键特性是支持TrustZone，使用一个地址阶段的信号HNONSEC来表示security transfer属性</font></p>
<ul>
<li>If HNONSEC is 1 (Non-secure), the bus interconnect must block the transfer if the address of the<br>transfer is pointing to a Secure location.</li>
<li>If HNONSEC is 0 (Secure), the bus master has Secure access privilege</li>
</ul>
<blockquote>
<p>in Armv8-M, when a processor is in Secure state, access to Non-secure address is indicated as Non-secure (HNONSEC&#x3D;&#x3D;1).  </p>
</blockquote>
<p>A TrustZone capable Cortex-M23&#x2F;M33 processor system should have:</p>
<ul>
<li>Secure and Non-secure program spaces.</li>
<li>Secure and Non-secure RAM spaces.</li>
<li>Secure and Non-secure peripherals.</li>
</ul>
<p>The definitions of Secure and Non-secure address ranges are handled by a Security Attribution Unit<br>(SAU) inside the processor and Implementation Defined Attribution Unit (IDAU) which is tightly<br>coupled to the processor(s). SAU is programmable, and IDAU is system-specific, in some cases, even<br>the IDAU could be programmable.  </p>
<p>To enable a high level of flexibility, Arm Corstone foundation IP &#x2F; CoreLink SDK-200 included several<br>bus components for TrustZone security management:</p>
<ul>
<li>Memory Protection Controller (MPC): for the partitioning of a memory block into Secure and Nonsecure address spaces.</li>
<li>Peripheral Protection Controller (PPC): for assigning bus peripherals into Secure and Non-secure domains.</li>
<li>Master security controller: An AHB5 bus wrapper for legacy bus masters that do not support TrustZone. This handles the blocking of Non-secure transfers to Secure addresses and generation of correct HNONSEC signals.</li>
</ul>
<blockquote>
<p>总结：</p>
<p>Trust zone特性需要处理器支持，也需要BUS支持；</p>
</blockquote>
<h1 id="Overview-of-APB"><a href="#Overview-of-APB" class="headerlink" title="Overview of  APB"></a>Overview of  APB</h1><h2 id="Introduction-to-the-APB-bus-system"><a href="#Introduction-to-the-APB-bus-system" class="headerlink" title="Introduction to the APB bus system"></a>Introduction to the APB bus system</h2><p>APB是一个简单的总线，其主要目的是为了连接外设。在AMBA2 中被引进，AMBA 3和AMBA 4中扩展了特性，允许wait states, error responses and additional transfer attributes (including TrustZone support)  。</p>
<p>将外设直接连接到APB而不是AHB有如下好处：</p>
<p>1、SoC中有很多外设，如果直接连接到AHB总线，由于信号的高扇出以及复杂的总线译码逻辑，总线频率可能会被降低，外设连接到APB上就可以降低对AHB的影响；</p>
<p>2、外设系统可以运行在不同的时钟频率，降低功耗；</p>
<p>3、外设使用APB接口可以简化设计复杂度；</p>
<p>4、大部分传统外设使用的是APB接口；</p>
<p>PRESETn相对于PCLK应该是异步复位同步释放的；</p>
<h2 id="APB-signals-and-connection"><a href="#APB-signals-and-connection" class="headerlink" title="APB signals and connection"></a>APB signals and connection</h2><img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240623220801138.png" class="">

<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240623220455386.png" class="">

<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240625162045548.png" class="">

<p><font color=blue>APB不是pipeline协议</font></p>
<p><font color=blue>AMBA2 APB的transfer必须是2T，因为没有pready信号</font></p>
<ul>
<li><p><font color=blue>对读操作，rdata必须在第二个时钟周期有效；</font></p>
</li>
<li><p><font color=blue>对写操作，wdata必须在2T时间里一直有效；（因为APB Slave的写传输实际可能在第一T，也可能在第二T，由具体的实现所定义）</font></p>
</li>
</ul>
<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240625162445025.png" class="">

<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240625162505870.png" class="">

<p><font color=blue>AMBA3 APB引入PREADY以及PSLVERR</font></p>
<p>因为APB不是pipeline的协议，所以第一个阶段不需要看pready信号！！！只在第二个阶段看pready信号；AHB如果第一个阶段不看hready信号，会造成协议冲突</p>
<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240625171242828.png" class="">

<blockquote>
<p>read transfer至少两个cycle，而且结尾是通过pready assert标明；</p>
<p>pready信号在transfer的第一个cycle被忽略；</p>
</blockquote>
<h2 id="Additional-signals-in-APB-protocol-v2-0"><a href="#Additional-signals-in-APB-protocol-v2-0" class="headerlink" title="Additional signals in APB protocol v2.0"></a>Additional signals in APB protocol v2.0</h2><p><font color=blue>The APB v2 in AMBA 4 added the PPROT and PSTRB signals </font></p>
<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240625172653938.png" class=""> 

<blockquote>
<p>Please note, unlike AHB5, the TrustZone security attribute is part of PPROT instead of a separate signal.  </p>
</blockquote>
<img src="/2024/06/20/3-AMBA-AHB-APB%EF%BC%883%EF%BC%89/image-20240625172821510.png" class=""> 

<blockquote>
<p>The PSTRB signal is active high and is used for write-operations only. </p>
<p>During read operations, the PSTRB signal is ignored by the bus slave, and the whole 32-bit word is read.  </p>
</blockquote>
<h2 id="Data-values-on-APB"><a href="#Data-values-on-APB" class="headerlink" title="Data values on APB"></a>Data values on APB</h2><p>如果APB是32bits的话，地址传输需要word对齐；</p>
<p>write transfer的时候，wdata在整个传输周期有效；</p>
<p>read transfer的时候，rdata最少要在transfer的last cycle有效；</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/18/python%E8%84%9A%E6%9C%AC%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/18/python%E8%84%9A%E6%9C%AC%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0/" class="post-title-link" itemprop="url">python脚本传递参数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-18 13:35:00" itemprop="dateCreated datePublished" datetime="2024-06-18T13:35:00+08:00">2024-06-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-21 09:34:35" itemprop="dateModified" datetime="2024-06-21T09:34:35+08:00">2024-06-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ip%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" itemprop="url" rel="index"><span itemprop="name">ip开发环境搭建</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/ip%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/python%E8%84%9A%E6%9C%AC/" itemprop="url" rel="index"><span itemprop="name">python脚本</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/18/python%E8%84%9A%E6%9C%AC%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/18/python%E8%84%9A%E6%9C%AC%E4%BC%A0%E9%80%92%E5%8F%82%E6%95%B0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>在执行python脚本的时候，有时候想要传递几个参数，给脚本中的变量进行赋值；</p>
<p>例如input_file, output file等等</p>
</blockquote>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://wzjsdyx.github.io/2024/06/17/SMIC-eflash-controller-design%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/animal_toy_cute_doll_teddy_256.png">
      <meta itemprop="name" content="Youngster">
      <meta itemprop="description" content="show me bug">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="芯青年">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/06/17/SMIC-eflash-controller-design%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">SMIC auto eflash controller design学习</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              

              <time title="创建时间：2024-06-17 14:32:49 / 修改时间：15:05:31" itemprop="dateCreated datePublished" datetime="2024-06-17T14:32:49+08:00">2024-06-17</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/eflash/" itemprop="url" rel="index"><span itemprop="name">eflash</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/eflash/eflash-controller/" itemprop="url" rel="index"><span itemprop="name">eflash controller</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Valine：</span>
    
    <a title="valine" href="/2024/06/17/SMIC-eflash-controller-design%E5%AD%A6%E4%B9%A0/#valine-comments" itemprop="discussionUrl">
      <span class="post-comments-count valine-comment-count" data-xid="/2024/06/17/SMIC-eflash-controller-design%E5%AD%A6%E4%B9%A0/" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <blockquote>
<p>saisai smic auto eflash controller design review study</p>
</blockquote>
<p>page erase</p>
<p>share 同一颗charge pump的Flash IP，不能同时擦写；</p>
<p>flash controller 掉电</p>
<p>flash macro掉电</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/3/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><span class="page-number current">4</span><a class="page-number" href="/page/5/">5</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/5/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Youngster"
      src="/images/animal_toy_cute_doll_teddy_256.png">
  <p class="site-author-name" itemprop="name">Youngster</p>
  <div class="site-description" itemprop="description">show me bug</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">140</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">35</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">138</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Youngster</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  


<script>
NexT.utils.loadComments(document.querySelector('#valine-comments'), () => {
  NexT.utils.getScript('//unpkg.com/valine/dist/Valine.min.js', () => {
    var GUEST = ['nick', 'mail', 'link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item => {
      return GUEST.includes(item);
    });
    new Valine({
      el         : '#valine-comments',
      verify     : false,
      notify     : false,
      appId      : '3qPpN2UkBU7Q1vhWnH1WdrQZ-gzGzoHsz',
      appKey     : 'LAapaVzfFkIj1knpaWSWCNDo',
      placeholder: "Looking forward to communication.",
      avatar     : 'monsterid',
      meta       : guest,
      pageSize   : '10' || 10,
      visitor    : false,
      lang       : 'zh-cn' || 'zh-cn',
      path       : location.pathname,
      recordIP   : false,
      serverURLs : ''
    });
  }, window.Valine);
});
</script>

</body>
</html>
